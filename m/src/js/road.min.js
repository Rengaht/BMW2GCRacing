for(var fps=60,step=1/fps,width=null,height=null,offset_width=null,centrifugal=.3,offRoadDecel=.99,skySpeed=.001,hillSpeed=.002,treeSpeed=.003,skyOffset=0,hillOffset=0,treeOffset=0,segments=[],cars=[],background=null,sprites=null,resolution=null,roadWidth=2191,segmentLength=1e3,rumbleLength=3,trackLength=null,lanes=3,fieldOfView=134,cameraHeight=1e3,cameraDepth=null,drawDistance=40,mDrawSegment=8,segmentPerDraw=Math.floor(drawDistance/mDrawSegment),spritePerDraw=drawDistance,playerX=0,playerZ=8*segmentLength,fogDensity=5,position=0,speed=0,accel=0,lastPlayerSegment=0,indexScene=0,totalScene=3,sceneInterval=[25,20,15],sceneLapsedInterval=[],tmp=0,i=0;i<totalScene;++i)tmp+=sceneInterval[i],sceneLapsedInterval.push(tmp);var sceneSpeedRatio=[0,1.25,1.5,2],lengthScene=200,BaseSpeed=lengthScene*segmentLength/(sceneInterval[0]*(sceneSpeedRatio[0]+sceneSpeedRatio[1])/2),isPlaying=!1,maxSpeed=BaseSpeed*sceneSpeedRatio[sceneSpeedRatio.length-1],sceneSegment=[];tmp=0;for(i=0;i<totalScene;++i){let e=.5*BaseSpeed*(sceneSpeedRatio[i]+sceneSpeedRatio[i+1])*sceneInterval[i];tmp+=Math.ceil(e/segmentLength),sceneSegment.push(tmp)}var score=0,MaxLife=3,life=MaxLife,totalCars=[5,8,12],sidePosition=[-2,2,0],onRoadPosition=[-1,0,1],CoinFlyVel=.1,CoinScale=.82,ObstacleScale=1.12,startGateZ=19*segmentLength,endGateZ=19*segmentLength,currentLapTime=0,lastLapTime=null,keyLeft=!1,keyRight=!1,keyFaster=!1,keySlower=!1,hud=null;function update(e){var t,n,s,a;_game_elapse_time>=0&&(_game_elapse_time+=e);var o=findSegment(position+playerZ);isPlaying?(position=Math.min(position+e*speed,trackLength),speed=speed<BaseSpeed?Math.min(speed+e*accel*5,sceneSpeedRatio[indexScene+1]*BaseSpeed):Math.min(speed+e*accel,sceneSpeedRatio[indexScene+1]*BaseSpeed),currentLapTime+=e):(position=Math.min(position+e*speed,trackLength),speed=Math.max(speed-80*accel*e,0)),updateCars(e,o,m),o.index>sceneSegment[indexScene]?indexScene<totalScene-1?setupScene(indexScene+1):(_ribbon.visible=!0,endGame()):0==indexScene&&_game_elapse_time<4&&_game_elapse_time>=1&&(_game_elapse_time>=2?_game_elapse_time>=3?isPlaying||(isPlaying=!0,_car.gotoAndPlay(0),_sound_game.play(),_sound_game.fade(.5,1,1e3),_sound_game.seek(0)):setTrafficLight(2):setTrafficLight(1));let r=Math.min(position,sceneSegment[2]*segmentLength-endGateZ);var i=findSegment(r),l=Util.percentRemaining(r,segmentLength),d=Util.percentRemaining(position+playerZ,segmentLength*segmentPerDraw),c=Util.interpolate(o.p1.world.y,o.p2.world.y,d),p=0,f=-i.curve*l;for(t=0;t<drawDistance;t++){segment=segments[(i.index+t)%segments.length],segment.looped=segment.index<i.index,segment.fog=Util.exponentialFog(t/drawDistance,fogDensity);let e=playerX*roadWidth*2;Util.project(t,segment.p1,e-p,c+cameraHeight,r,cameraDepth,width,height,roadWidth),Util.project(t+1,segment.p2,e-p-f,c+cameraHeight,r,cameraDepth,width,height,roadWidth),p+=f,f+=segment.curve;for(var g=0;g<segment.coins.length;g++)segment.coins[g].offsetY>0&&(segment.coins[g].offsetY=Math.min(segment.coins[g].offsetY+CoinFlyVel,1));for(g=0;g<segment.obstacles.length;g++)segment.obstacles[g].offsetY>0&&(segment.obstacles[g].offsetY=Math.min(segment.obstacles[g].offsetY+CoinFlyVel,1))}for(g=0;g<cars.length;g++)cars[g].offsetY>0&&(cars[g].offsetY=Math.min(cars[g].offsetY+CoinFlyVel,1));var m=_car.textures[0].width*CarScale,h=2*e*Math.min(2,speed/BaseSpeed*4),S=position;if(keyLeft?playerX-=h:keyRight&&(playerX+=h),playerX=Util.limit(playerX,onRoadPosition[0],onRoadPosition[2]),isPlaying){if(lastPlayerSegment!=o.index){let e=segments[o.index];e.p1.project.y,RoadRatio,SideSpriteXScale,SpriteScale;for(t=0;t<e.coins.length;t++)s=e.coins[t],a=.5,Util.overlap(playerX,.5,s.offsetX,a)&&(score+=e.coins[t].score,s.offsetY+=CoinFlyVel,e.coins[t].score>1?_sound_fx.combo.play():_sound_fx.coin.play());for(t=0;t<e.obstacles.length;t++)if(s=e.obstacles[t],a=.5,Util.overlap(playerX,.5,s.offsetX,a)){life-=1,s.offsetY+=CoinFlyVel,_sound_fx.bump.play(),life<=0&&endGame(!0);break}}for(t=0;t<cars.length;t++)if(n=cars[t],!(Math.abs(n.segment-o.index)>drawDistance)){if(.5,n.offsetY<=0&&n.segment==o.index&&Util.overlap(playerX,.5,n.offsetX,.5)){life-=1,n.offsetY+=CoinFlyVel,_sound_fx.bump.play(),life<=0&&endGame(!0);break}n.playSound||(2*Math.random()<1?_sound_fx.other_car.play():_sound_fx.horn.play(),n.playSound=!0)}}if(skyOffset=Util.increase(skyOffset,skySpeed*o.curve*(position-S)/segmentLength,1),hillOffset=Util.increase(hillOffset,hillSpeed*o.curve*(position-S)/segmentLength,1),treeOffset=Util.increase(treeOffset,treeSpeed*o.curve*(position-S)/segmentLength,1),lastPlayerSegment=o.index,indexScene>0){let e=i.index-sceneSegment[indexScene-1];e<=40&&setShaderUniforms(indexScene-1,indexScene,Math.min(1,e/30))}updateHud()}function updateCars(e,t,n){var s,a,o,r;for(s=0;s<cars.length;s++)a=cars[s],o=segments[a.segment],a.segment<t.index||a.segment-t.index>drawDistance||(a.offsetX=a.offsetX+updateCarOffset(a,a.segment,t,n),a.offsetX=Util.limit(a.offsetX,onRoadPosition[0],onRoadPosition[2]),a.z=Util.increase(a.z,e*speed*.6,trackLength),a.percent=Util.percentRemaining(a.z,segmentLength),r=findSegment(a.z),a.segment=r.index,o!=r&&(index=o.cars.indexOf(a),o.cars.splice(index,1),r.cars.push(a)))}function updateCarOffset(e,t,n,s){var a,o,r,i,l,d=Math.min(2,e.speed/BaseSpeed*4),c=[!1,!1,!1];for(r=1;r<10;r++){var p;for(i=segments[(t+r)%segments.length],a=0;a<i.obstacles.length;++a)(p=i.obstacles[a]).offsetX<0?c[0]=!0:p.offsetX>0?c[2]=!0:c[1]=!0}for(o=0;o<cars.length;o++)(l=cars[o]).index!=e.index&&l.segment>e.segment&&l.segment<e.segment+10&&(l.offsetX<0?c[0]=!0:l.offsetX>0?c[2]=!0:c[1]=!0);var f=Util.limit(Math.floor(e.offsetX+1),0,2);if(0==f&&c[0])return d;if(2==f&&c[2])return-d;if(1==f&&c[1]){if(!c[0])return-d;if(!c[2])return d;speed=0}return 0}function updateHud(){let e=Util.interpolate(0,200,speed/maxSpeed);updateHudElement("speed",Math.round(e));let t=Util.interpolate(-65,135,e/200);$("#_speed_pointer").css("transform","rotate("+t+"deg)");let n=playerZ/segmentLength;updateHudElement("time",formatTime(sceneLapsedInterval[totalScene-1]*Math.max(0,1-(lastPlayerSegment-n)/(sceneSegment[totalScene-1]-n)))),updateHudElement("life",Math.max(0,life)),updateHudElement("score",pad(score,3))}function updateHudElement(e,t){hud[e].value!==t&&(hud[e].value=t,Dom.set(e,t,hud[e].dom))}function formatTime(e){var t=Math.floor(e),n=Math.floor(100*(e-Math.floor(e)));return pad(t,2)+":"+pad(n,2)}function pad(e,t,n){return n=n||"0",(e+="").length>=t?e:new Array(t-e.length+1).join(n)+e}function render(){let e=Math.min(position,sceneSegment[2]*segmentLength-endGateZ);var t,n,s,a,o,r,i,l,d,c,p,f,g,m=findSegment(e),h=(Util.percentRemaining(e,segmentLength),findSegment(position+playerZ)),S=Util.percentRemaining(position+playerZ,segmentLength),u=Util.interpolate(h.p1.world.y,h.p2.world.y,S),R=height;for(Render.background(_sky,width,height,skyOffset,resolution*skySpeed*u,m.index/sceneSegment[totalScene-1]),_mountain.x=_dest_mountain*(h.index/sceneSegment[2]),t=0;t<_scene_road.children.length;++t)_scene_road.getChildAt(t).visible=!1;for(t=0;t<_scene_side.children.length;++t)_scene_side.getChildAt(t).visible=!1;for(t=0;t<_other_car.children.length;++t)_other_car.getChildAt(t).visible=!1;for(_start_gate.visible=!1,t=0;t<drawDistance;t++)m.index+t>segments.length-1||(s=segments[m.index+t]).p1.camera.z<=cameraDepth||s.p2.screen.y>=s.p1.screen.y||s.p2.screen.y>=R||(Render.segment(Math.round(m.index+t),width,lanes,s.p1.screen.x,s.p1.screen.y,s.p1.screen.w,s.p2.screen.x,s.p2.screen.y,s.p2.screen.w,s.fog,s.scene),R=s.p1.screen.y);for(t=0;t<drawDistance;++t){if(m.index+t>segments.length-1)continue;s=segments[m.index+t];let e=(m.index+t)%drawDistance,S=findSegmentScene(s.index);var _=[!1,!1,!1];for(n=0;n<s.sprites.length;n++){l=s.sprites[n],o=s.p1.project.y*height*RoadRatio*SideSpriteXScale*SpriteScale,r=offset_width+s.p1.screen.x+l.offset*Math.abs(s.p1.screen.w),i=s.p1.screen.y,g=1;let a=drawDistance-t;l.source!==GATE.START?(l.source===GATE.GOAL?(updateRibbon(r,i,o,a),f=resources.gate.textures[l.source]):f=_texture_scene[S][l.source],Render.sprite(_scene_side.getChildAt(2*e+(l.offset<0?0:1)),f,r,i,o,a,g)):(f=resources.gate.textures[l.source],a=drawDistance,Render.trafficLight(_container_traffic_light,r,i,o,a),Render.sprite(_start_gate,f,r,i,o,a,g))}for(n=0;n<s.coins.length;++n)_[c=0==(d=s.coins[n]).offsetX?0:d.offsetX<0?1:2]||(o=CoinScale*s.p1.project.y*height*RoadRatio*RoadSpriteXScale*SpriteScale*(1-d.offsetY),r=offset_width+s.p1.screen.x+d.offsetX*Math.abs(s.p1.screen.w)/lanes*2,i=s.p1.screen.y-Util.easeInOut(0,1,d.offsetY)*height,g=1,f=d.source===SPRITE_ROAD.COMBO[0]?Math.floor(1e3*currentLapTime)%600>=300?_texture_road[SPRITE_ROAD.COMBO[0]]:_texture_road[SPRITE_ROAD.COMBOGLOW[0]]:_texture_road[d.source],Render.sprite(_scene_road.getChildAt(3*e+c),f,r,i,o,drawDistance-t,g));for(n=0;n<s.obstacles.length;++n)_[c=0==(p=s.obstacles[n]).offsetX?0:p.offsetX<0?1:2]||(o=ObstacleScale*s.p1.project.y*height*RoadRatio*RoadSpriteWScale*SpriteScale*1.2*(1-p.offsetY),r=offset_width+s.p1.screen.x+p.offsetX*Math.abs(s.p1.screen.w)/lanes*2,i=s.p1.screen.y-Util.easeInOut(0,1,p.offsetY)*height,g=1,f=_texture_road[p.source],c=0==p.offsetX?0:p.offsetX<0?1:2,Render.sprite(_scene_road.getChildAt(3*e+c),f,r,i,o,drawDistance-t,g));for(n=0;n<s.cars.length;++n){(a=s.cars[n]).offsetX<0&&playerX>=0||0==a.offsetX&&playerX>0?l=OTHER_CAR[a.color].left:a.offsetX>0&&playerX<=0||0==a.offsetX&&playerX<0?OTHER_CAR[a.color].right:l=OTHER_CAR[a.color].center,f=resources.other_car.textures[l];var C=Util.interpolate(s.p1.project.y,s.p2.project.y||0,a.percent);if(!(C<yproj[mDrawSegment])){var D=Util.interpolate(s.p1.screen.x,s.p2.screen.x||0,a.percent),L=Util.interpolate(s.p1.screen.y,s.p2.screen.y||0,a.percent),M=Util.interpolate(s.p1.screen.w,s.p2.screen.w||0,a.percent);o=C*height*RoadRatio*RoadSpriteWScale*SpriteScale*1.2*(1-a.offsetY),r=offset_width+D+a.offsetX*Math.abs(M)/lanes*2,i=L-Util.easeInOut(0,1,a.offsetY)*height,Render.sprite(_other_car.getChildAt(a.index%_other_car.children.length),f,r,i,o,cars.length-n,g)}}if(s==h){var y=CarScale,O=offset_width+width/2,E=height;s.index>sceneSegment[2]-endGateZ/segmentLength&&(y=s.index>=sceneSegment[2]+drawDistance-endGateZ/segmentLength?0:s.p1.project.y*height*RoadRatio*RoadSpriteWScale*SpriteScale*1.2,O=offset_width+s.p1.screen.x+playerX*Math.abs(s.p1.screen.w)/lanes*2,E=s.p1.screen.y),Render.player(resolution,speed/BaseSpeed,y,O,E,speed*(keyLeft?-1:keyRight?1:0))}}}function findSegment(e){return segments[Math.floor(e/segmentLength)%segments.length]}function findSegmentScene(e){for(var t=0;t<totalScene;++t)if(e<=sceneSegment[t])return t;return totalScene-1}function lastY(){return 0==segments.length?0:segments[segments.length-1].p2.world.y}function addSegment(e,t,n){var s=segments.length;segments.push({index:s,p1:{world:{y:lastY(),z:s*segmentLength},camera:{},screen:{},project:[]},p2:{world:{y:t,z:(s+1)*segmentLength},camera:{},screen:{},project:[]},curve:e,sprites:[],cars:[],coins:[],obstacles:[],color:Math.floor(s/rumbleLength)%2?COLORS.DARK:COLORS.LIGHT,scene:n})}function addSprite(e,t,n){segments[e].sprites.push({source:t,offset:n})}function addRoad(e,t,n,s,a,o){var r,i=lastY(),l=i+Util.toInt(a,0)*segmentLength,d=e+t+n;for(r=0;r<e;r++)addSegment(Util.easeIn(0,s,r/e),Util.easeInOut(i,l,r/d),o);for(r=0;r<t;r++)addSegment(s,Util.easeInOut(i,l,(e+r)/d),o);for(r=0;r<n;r++)addSegment(Util.easeInOut(s,0,r/n),Util.easeInOut(i,l,(e+t+r)/d),o)}var ROAD={LENGTH:{NONE:0,SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{NONE:0,EASY:2,MEDIUM:4,HARD:6}};function addStraight(e,t){addRoad(0,e=e||ROAD.LENGTH.MEDIUM,0,0,0,t)}function addHill(e,t,n){addRoad(e=e||ROAD.LENGTH.MEDIUM,e,e,0,t=t||ROAD.HILL.MEDIUM,n)}function addCurve(e,t,n,s){addRoad(e=e||ROAD.LENGTH.MEDIUM,e,e,t=t||ROAD.CURVE.MEDIUM,n=n||ROAD.HILL.NONE,s)}function addLowRollingHills(e,t,n){addRoad(e=e||ROAD.LENGTH.SHORT,e,e,0,(t=t||ROAD.HILL.LOW)/2,n),addRoad(e,e,e,0,-t,n),addRoad(e,e,e,ROAD.CURVE.EASY,t,n),addRoad(e,e,e,0,0,n),addRoad(e,e,e,-ROAD.CURVE.EASY,t/2,n),addRoad(e,e,e,0,0,n)}function addSCurves(e){addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.NONE,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.EASY,-ROAD.HILL.LOW,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.MEDIUM,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.MEDIUM,-ROAD.HILL.MEDIUM,e)}function addBumps(e){addRoad(10,10,10,0,5,e),addRoad(10,10,10,0,-2,e),addRoad(10,10,10,0,-5,e),addRoad(10,10,10,0,8,e),addRoad(10,10,10,0,5,e),addRoad(10,10,10,0,-7,e),addRoad(10,10,10,0,5,e),addRoad(10,10,10,0,-2,e)}function addDownhillToEnd(e,t){addRoad(e=e||200,e,e,-ROAD.CURVE.EASY,-lastY()/segmentLength,t)}function resetRoad(e,t){segments=[],addStraight(sceneSegment[0],0),addStraight(sceneSegment[1]-sceneSegment[0],1);let n=startGateZ/segmentLength;addStraight(sceneSegment[2]-sceneSegment[1]+drawDistance,2),addSprite(n,GATE.START,0),addSprite(sceneSegment[totalScene-1],GATE.GOAL,0),readMap(e,t),trackLength=segments.length*segmentLength}function setupScene(e){indexScene=e,console.log("-------------Enter scene "+e+"  "+formatTime(currentLapTime)+"-------------"),speed=sceneSpeedRatio[e]*BaseSpeed,accel=0==e?(sceneSpeedRatio[e+1]*BaseSpeed-speed)/3:(sceneSpeedRatio[e+1]*BaseSpeed-speed)/sceneInterval[e],console.log("v= "+speed+"  a= "+accel)}function lerpColor(e,t,n){return new Float32Array([Util.interpolate(e[0],t[0],n),Util.interpolate(e[1],t[1],n),Util.interpolate(e[2],t[2],n),Util.interpolate(e[3],t[3],n)])}function setShaderUniforms(e,t,n){_shader_road.uniforms.roadColor1=lerpColor(SceneColor[e].roadColor1,SceneColor[t].roadColor1,n),_shader_road.uniforms.roadColor2=lerpColor(SceneColor[e].roadColor2,SceneColor[t].roadColor2,n),_shader_road.uniforms.laneColor1=lerpColor(SceneColor[e].laneColor1,SceneColor[t].laneColor1,n),_shader_road.uniforms.laneColor2=lerpColor(SceneColor[e].laneColor2,SceneColor[t].laneColor2,n),_shader_road.uniforms.grassColor1=lerpColor(SceneColor[e].grassColor1,SceneColor[t].grassColor1,n),_shader_road.uniforms.grassColor2=lerpColor(SceneColor[e].grassColor2,SceneColor[t].grassColor2,n),_shader_road.uniforms.grassColor3=lerpColor(SceneColor[e].grassColor3,SceneColor[t].grassColor3,n),_shader_road.uniforms.grassColor4=lerpColor(SceneColor[e].grassColor4,SceneColor[t].grassColor4,n),_shader_road.uniforms.sideColor1=lerpColor(SceneColor[e].sideColor1,SceneColor[t].sideColor1,n),_shader_road.uniforms.sideColor2=lerpColor(SceneColor[e].sideColor2,SceneColor[t].sideColor2,n)}