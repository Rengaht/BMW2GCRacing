var _next_page,_driver_name,_guid,_cur_page="_home",_pre_page="_home",_driver_color="blue",_agree=!1,_trial_selected=!0;const ClickBorder=.5;var _isVender,_inTransition=!1,RankCount=50;function closePage(e,t){switch(e){case"_home":"_rank"!==t&&hideItem($("#_button_rank")),"_campaign"===t&&$("#"+e).removeClass("pageToBase");break;case"_lottery":"_campaign"!==t&&(hideItem($("#_button_back")),$("#"+e).removeClass("pageToBase"));break;case"_rank":hideItem($("#_button_back")),$("#"+e).removeClass("pageToBase");break;case"_driver":"_color"===t&&($("#"+e).removeClass("pageToBase"),$("#"+e).addClass("pageToTop")),"_campaign"===t&&$("#"+e).removeClass("pageToTop");break;case"_color":"_game"===t&&($("#"+e).removeClass("pageToBase"),$("#"+e).removeClass("pageToBottom"),$("#"+e).addClass("pageToTop"),hideItem($("#_button_back"))),"_driver"===t&&$("#"+e).removeClass("pageToBase");break;case"_game":$("#_game").addClass("hidden"),"_home"===t?hideItem($("#_score")):(hideItem($("#_button_rank")),$("#"+e).addClass("pageToTop"),$("#_score").addClass("pageToTop"));break;case"_campaign":$("#_button_ok_campaign").removeClass("Click"),"_home"===t?hideItem($("#_button_back")):"_driver"!==t&&"_lottery"!==t||$("#"+e).removeClass("pageToBase")}}function setupPage(e){if("game"!==e)try{_sound_bgm.playing()||(_sound_bgm.play(),_sound_bgm.fade(0,1,2e3))}catch(e){console.log(e)}switch(e){case"_home":showItem($("#_button_control")),$("#_button_start").removeClass("Click"),$("#"+e).addClass("pageToBase"),$("#_campaign").hasClass("pageToBase")||$("#_campaign").addClass("pageToBase"),_game_elapse_time=-1,gtag("event","back"),gtag("event","Nav Click",{event_category:"Click",event_label:"back"});break;case"_driver":$("#_button_ok").removeClass("Click"),$("#_button_back").removeClass("Click"),$("#_input_driver").blur(),"_campaign"===_cur_page&&($("#_input_driver").val(""),_driver_name=""),"_color"===_cur_page&&$("#"+e).removeClass("pageToTop");break;case"_color":$("#_button_go").removeClass("Click"),$("#_button_back").removeClass("Click"),$("#"+e).addClass("pageToBase");break;case"_game":$("#_game").removeClass("hidden"),"_color"===_cur_page?(setupGame(),hideItem($("#_button_rank")),hideItem($("#_score")),movePage($("#_score_board"),"pageToTop"),showItem($("#_rule")),movePage($("#_rule_board"),"pageToTop"),$("#"+e).removeClass("pageToTop"),$("#_score").removeClass("pageToTop"),movePage($("#"+e),"pageFromBase")):(showItem($("#_button_rank")),$("#"+e).removeClass("pageToTop"),$("#_score").removeClass("pageToTop"));break;case"_rank":hideItem($("#_button_rank")),$("#_button_back").removeClass("Click"),$("#"+e).addClass("pageToBase");break;case"_lottery":"_game"===_cur_page&&clearInfo(),onClickGotoTrial(!0),$("#_button_send").removeClass("Click"),$("#_button_back").removeClass("Click"),hideItem($("#_button_rank")),$("#"+e).addClass("pageToBase"),gtag("event","Participate"),gtag("event","Nav Click",{event_category:"Click",event_label:"Participate"});break;case"_campaign":$("#_campaign_wrapper").scrollTop(0),$("#_campaign").hasClass("pageToBase")||$("#"+e).addClass("pageToBase")}}function needScroll(e){return e.parent().get(0).scrollHeight>e.parent().get(0).clientHeight}function gotoPage(e,t){if(_cur_page!==e&&!_inTransition){_inTransition=!0;try{switch(t){case"bb":_sound_fx.button_large.play();break;case"sb":_sound_fx.button_small.play()}}catch(e){console.log(e)}closePage(_cur_page,e),setupPage(e),_next_page=e,setTimeout(function(){onPageTransitionEnd()},500)}}function onPageTransitionEnd(){switch($("body").scrollTop(0),_inTransition=!1,_pre_page=_cur_page,_cur_page=_next_page,$("#_button_back").removeClass("Click"),_cur_page){case"_home":showItem($("#_button_rank")),$("#_driver").removeClass("pageToTop"),$("#_driver").addClass("pageToBase"),$("#_color").removeClass("pageToTop"),$("#_color").addClass("pageToBottom"),resetDriverColor();break;case"_driver":showItem($("#_button_back"));break;case"_color":break;case"_game":"_color"===_pre_page?(showItem($("#_rule")),movePage($("#_rule_board"),"pageFromTop"),hideItem($("#_button_control")),$("#_button_lottery").removeClass("Disable"),$("#_button_lottery").removeClass("Click")):(movePage($("#_score_board"),"pageFromBase"),hideItem($("#_button_control")));break;case"_lottery":showItem($("#_button_back")),$("#_button_send").removeClass("Disable"),$("#_button_send").removeClass("Click");break;case"_rank":showItem($("#_button_back")),updateRank();break;case"_campaign":showItem($("#_button_back"))}}function hideItem(e){e.hasClass("hidden")&&e.hasClass("close")||(e.addClass("hidden"),setTimeout(function(){e.addClass("close")},600))}function showItem(e){(e.hasClass("hidden")||e.hasClass("close"))&&(e.removeClass("close"),setTimeout(function(){e.removeClass("hidden")},10))}function movePage(e,t,o){var a=t;setTimeout(function(){e.addClass(t)},100),setTimeout(function(){e.removeClass(a)},600)}function onButtonStartClick(){$("#_button_start").hasClass("Disable")||_inTransition||(gtag("event","CLICK_M_START"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_START"}),$("#_button_start").addClass("Click"),gotoPage("_campaign","bb"))}function onDriverNameClick(){_inTransition||(checkNameInput()?($("#_button_ok").addClass("Click"),setDriverName($("#_input_driver").val()),gotoPage("_color","bb")):_sound_fx.button_disable.play())}function setDriverName(e){_driver_name=e,$("#_driver_name_in_game").text(_driver_name),$("#_driver_name_complete").text(_driver_name)}function setDriverColor(e){_inTransition||e!==_driver_color&&(_sound_fx.button_small.play(),hideItem($("#_button_"+_driver_color+"_selected")),$("#_img_car_color_"+_driver_color).addClass("hidden"),$("#_img_car_color_"+_driver_color).addClass("close"),showItem($("#_button_"+e+"_selected")),$("#_img_car_color_"+e).removeClass("hidden"),$("#_img_car_color_"+e).removeClass("close"),$("#_car_complete").attr("src","asset/img/ui/frontcar_"+e+".png"),_driver_color=e)}function resetDriverColor(){$("#_button_"+_driver_color+"_selected").addClass("hidden"),$("#_button_"+_driver_color+"_selected").addClass("close"),$("#_img_car_color_"+_driver_color).addClass("hidden"),$("#_img_car_color_"+_driver_color).addClass("close"),$("#_button_blue_selected").removeClass("hidden"),$("#_button_blue_selected").removeClass("close"),$("#_img_car_color_blue").removeClass("hidden"),$("#_img_car_color_blue").removeClass("close"),$("#_car_complete").attr("src","asset/img/ui/frontcar_blue.png"),_driver_color="blue"}function onButtonGoClick(){_inTransition||($("#_button_go").addClass("Click"),gotoPage("_game","bb"))}function onButtonRuleOkClick(){_inTransition||(_sound_fx.button_large.play(),_sound_bgm.fade(1,0,2e3),hideItem($("#_rule")),showItem($("#_button_control")),setTimeout(function(){showItem($("#_hint"))},800))}function setDriverScore(e){$("#_score_complete").text(e)}function onButtonLotteryClick(){$("#_button_lottery").hasClass("Disable")||_inTransition||(gtag("event","CLICK_M_RESULT_NEXT"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_RESULT_NEXT"}),gotoPage("_lottery","bb"))}function onButtonHomeClick(){if(_inTransition)return;let e="CLICK_M_COMPLETE_BACK";$("#_button_share").hasClass("hidden")&&(e="CLICK_M_RESULT_RETURN"),gtag("event",e),gtag("event","Nav Click",{event_category:"Click",event_label:e}),$("#_button_home").addClass("Click"),gotoPage("_home","bb")}function showScore(){$("#_rank_to_show").addClass("hidden"),$("#_score").removeClass("pageToTop"),showItem($("#_score")),showItem($("#_button_rank")),$("#_button_home").removeClass("Click"),$("#_button_lottery").removeClass("Click"),$("#_button_lottery").removeClass("Disable"),showItem($("#_button_lottery")),hideItem($("#_button_share")),hideItem($("#_button_the2")),hideItem($("#_button_control")),setTimeout(function(){movePage($("#_score_board"),"pageFromTop")},100)}function clearInfo(){$("#_input_lottery_name").val(""),$("#_input_lottery_gender").val("男"),$("#_input_lottery_age").val("20-"),$("#_input_lottery_phone").val(""),$("#_input_lottery_email").val(""),$("#_button_goto_trial_yes").addClass("checked"),$("#_button_goto_trial_no").removeClass("checked"),$("#_input_lottery_score").val("台北汎德 - 天母"),_agree=!1,$("#_button_agree").removeClass("checked"),$("#_lottery_input_error").text(""),toggleLotteryError(!1)}function sendInfo(e){if($("#_button_send").hasClass("Disable"))return;if(_inTransition)return;if(!checkLotteryInput())return void _sound_fx.button_disable.play();_trial_selected&&fbq("track","Lead"),gtag("event","CLICK_M_FORM_COMPLETE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_FORM_COMPLETE"}),_inTransition=!0,toggleLotteryError(!0,"傳送中..."),$("#_button_send").addClass("Click"),_sound_fx.button_large.play();let t={player:_driver_name,color:_driver_color,score:score,name:$("#_input_lottery_name").val(),gender:$("#_input_lottery_gender").val(),age:$("#_input_lottery_age").val(),phone:$("#_input_lottery_phone").val(),email:$("#_input_lottery_email").val(),trial:_trial_selected,store:$("#_input_lottery_store").val(),vender:_isVender?"TRUE":""};$.ajax({url:"https://script.google.com/macros/s/AKfycbxPGSHSW3HBjJ4WPmAXtTgUX2SKa6t0lH7M4zwQTcOYKaXGzzE9/exec",data:t,success:function(t){console.log("update info: "+t);var o=JSON.parse(t);_inTransition=!1,"success"===o.result?(toggleLotteryError(!0,"成功!"),gtag("event","complete"),gtag("event","Nav Click",{event_category:"Click",event_label:"complete"}),_rank=o.rank,$("#_rank_complete").text(_rank),$("#_rank_to_show").removeClass("hidden"),$("#_button_send").addClass("Disable"),_guid=o.uid,hideItem($("#_button_lottery")),$("#_button_share").removeClass("Click"),showItem($("#_button_share")),showItem($("#_button_the2")),setTimeout(function(){e&&e(),gotoPage("_game","bb")},300)):($("#_button_send").removeClass("Click"),$("#_button_send").removeClass("Disable"),toggleLotteryError(!0,"something wrong^^"))},error:function(e,t,o){alert("something wrong^^"),console.log(e)}})}function onButtonBackClick(){if(!_inTransition)switch($("#_button_back").addClass("Click"),_cur_page){case"_rank":gotoPage(_pre_page,"sb");break;case"_driver":gotoPage("_campaign","sb");break;case"_color":gotoPage("_driver","sb");break;case"_lottery":gotoPage("_game","sb");break;case"_campaign":"_lottery"===_pre_page&&gotoPage("_lottery","sb"),"_home"!==_pre_page&&"_driver"!==_pre_page||gotoPage("_home","sb")}}function onGameClick(e){if(e.preventDefault(),isPlaying){var t=e.offsetX/width;t<ClickBorder?keyLeft=!0:t>1-ClickBorder&&(keyRight=!0)}}function onGameMouseUp(e){e.preventDefault(),keyLeft=0,keyRight=0}function onClickGotoTrial(e){e?($("#_button_goto_trial_yes").addClass("checked"),$("#_button_goto_trial_no").removeClass("checked")):($("#_button_goto_trial_yes").removeClass("checked"),$("#_button_goto_trial_no").addClass("checked")),_trial_selected=e}function onClickAgree(){$("#_button_agree").hasClass("checked")?($("#_button_agree").removeClass("checked"),_agree=!1):($("#_button_agree").addClass("checked"),_agree=!0)}function updateRank(e){var t={count:RankCount};$.ajax({url:"https://script.google.com/macros/s/AKfycbzQIXck9QaCW1k5VmgW6WFOm5yQ35K2ULryaW8ilJ4K-uadGCI/exec",data:t,success:function(t){$("#_rank_info").empty();var o=JSON.parse(t),a=1;for(var _ in o){let e=o[_];if(""===e[2])break;let t=$("<div></div>");$("<sapn></span>").text(a+".").appendTo(t),$("<sapn></span>").text(e[0]).appendTo(t),$("<sapn></span>").text(e[2]).appendTo(t),t.addClass("RankItem"),t.addClass("hidden"),setTimeout(function(){t.removeClass("hidden")},100*_),t.appendTo($("#_rank_info")),a++}console.log("update rank!"),e&&e()},error:function(e,t,o){alert("something wrong^^"),console.log(e)}})}function checkNameInput(){var e="";return $("#_input_driver").val().length<1&&(e+="*不可空白"),$("#_input_driver").val($("#_input_driver").val().replace(/ /g,"").toUpperCase()),toggleNameError(e.length>0,e),0==e.length}function toggleNameError(e,t){e?($("#_driver_input_error").text(t),$("#_driver_input_error").removeClass("hidden"),$("#_button_ok").addClass("Disabled")):($("#_driver_input_error").addClass("hidden"),$("#_button_ok").removeClass("Disabled"))}function checkLotteryInput(){var e="";$("#_input_lottery_name").val().length<1&&(e+="*姓名不可空白\n");var t=$("#_input_lottery_phone").val();(t.length<12||!/^09\d{2}-\d{3}-\d{3}$/.test(t))&&(e+="*手機格式錯誤\n");var o=$("#_input_lottery_email").val().toLowerCase();return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(o)||(e+="*email格式錯誤\n"),_agree||(e+="*請同意個人資料使用"),toggleLotteryError(e.length>0,e),0==e.length}function toggleLotteryError(e,t){e?($("#_lottery_input_error").text(t),$("#_lottery_input_error").removeClass("hidden"),$("#_button_ok").addClass("Disabled")):($("#_lottery_input_error").addClass("hidden"),$("#_button_ok").removeClass("Disabled"))}function getUrlParameter(){new URL(window.location.href);_isVender=get("vender"),console.log("vender= "+_isVender)}function get(e){if(e=new RegExp("[?&]"+encodeURIComponent(e)+"=([^&]*)").exec(location.search))return decodeURIComponent(e[1])}function onButtonCampaignOkClick(){_inTransition||($("#_button_ok_campaign").addClass("Click"),"_lottery"===_pre_page?gotoPage("_lottery","sb"):gotoPage("_driver","bb"))}function onClickCampaignInfo(){_inTransition||(gtag("event","CLICK_M_FORM_MORE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_FORM_MORE"}),gotoPage("_campaign","bb"))}function isIpad(){const e=window.navigator.userAgent;if(e.indexOf("iPad")>-1)return!0;if(e.indexOf("Macintosh")>-1)try{return document.createEvent("TouchEvent"),!0}catch(e){}return!1}function onSoundButtonClick(){Howler._muted?(Howler.mute(!1),$("#_button_sound").attr("src","asset/img/ui/button_sound_on.png")):(Howler.mute(!0),$("#_button_sound").attr("src","asset/img/ui/button_sound_off.png"))}function onContinueButtonClick(){_sound_fx.button_small.play(),hideItem($("#_control")),"_game"===_cur_page&&resumeGame()}function onExitButtonClick(){_sound_fx.button_small.play(),hideItem($("#_control")),isPlaying&&exitGame(),gotoPage("_home")}function onButtonControlClick(){_sound_fx.button_small.play(),$("#_control").hasClass("hidden")?(pauseGame(),showItem($("#_control"))):(resumeGame(),hideItem($("#_control")))}function onButtonShareClick(){if(!_inTransition){gtag("event","CLICK_M_COMPLETE_SHARE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_COMPLETE_SHARE"}),_sound_fx.button_large.play(),$("#_button_share").addClass("Click"),_inTransition=!0;var e=new FormData;e.append("action","get_share_url"),e.append("guid",_guid),e.append("name",_driver_name),e.append("color",_driver_color),e.append("score",score),e.append("rank",_rank);$.ajax({url:"https://event.bmw.com.tw/campaign/2020/the2_racing_challenge/m/src/php/action.php",type:"POST",data:e,processData:!1,contentType:!1,cache:!1,success:function(e){_inTransition=!1,console.log(e),window.location.href=e.share_url},error:function(e,t,o){_inTransition=!1,console.log(e)}})}}function onButtonThe2Click(){gtag("event","CLICK_M_COMPLETE_EVENTSITE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_COMPLETE_EVENTSITE"}),window.open("https://event.bmw.com.tw/campaign/2020/2series-gran-coupe/?utm_source=THE2RACINGCHALLENGE","_blank")}getUrlParameter();