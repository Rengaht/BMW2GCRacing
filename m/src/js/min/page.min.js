function colorArray(e){return new Float32Array(e.map(function(e){return e/255}))}var SceneColor=[{roadColor1:colorArray([185,184,185,255]),roadColor2:colorArray([151,150,150,255]),laneColor1:colorArray([255,255,255,255]),laneColor2:colorArray([227,227,227,255]),grassColor1:colorArray([82,188,127,255]),grassColor2:colorArray([144,204,136,255]),grassColor3:colorArray([82,188,127,255]),grassColor4:colorArray([144,204,136,255]),sideColor1:colorArray([228,58,56,255]),sideColor2:colorArray([250,229,221,255])},{roadColor1:colorArray([14,74,94,255]),roadColor2:colorArray([0,53,79,255]),laneColor1:colorArray([254,229,110,255]),laneColor2:colorArray([15,180,223,255]),grassColor1:colorArray([45,44,130,255]),grassColor2:colorArray([30,67,153,255]),grassColor3:colorArray([45,44,130,255]),grassColor4:colorArray([30,67,153,255]),sideColor1:colorArray([195,124,180,255]),sideColor2:colorArray([255,245,229,255])},{roadColor1:colorArray([131,82,161,255]),roadColor2:colorArray([106,84,163,255]),laneColor1:colorArray([124,209,233,255]),laneColor2:colorArray([76,166,221,255]),grassColor1:colorArray([229,211,181,255]),grassColor2:colorArray([255,235,207,255]),grassColor3:colorArray([125,207,218,255]),grassColor4:colorArray([89,167,220,255]),sideColor1:colorArray([131,45,145,255]),sideColor2:colorArray([230,50,147,255])}],vertex_shader="precision highp float;\t\tattribute vec2 aVertexPosition;\t\tattribute vec2 aTextureCoord;\t\tuniform mat3 projectionMatrix;\t\tuniform mat3 translationMatrix;\t\tuniform mat3 uTextureMatrix;\t\tvarying vec3 vTextureCoord;\t\tvarying float vColor;\t\tvoid main(void)\t\t{\t\t\tgl_Position.xyw = projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0);\t\t\tgl_Position.z = 0.0;\t\t\tvColor=floor(aTextureCoord.x);\t\t\tvTextureCoord = vec3(aVertexPosition.x,(aTextureCoord.x-vColor)/.5,aTextureCoord.y);\t\t}",frag_shader="varying vec3 vTextureCoord;\tvarying float vColor;\tuniform vec4 uColor;\tuniform sampler2D uSampler;\tuniform float width;\t\tuniform vec4 roadColor1;\tuniform vec4 roadColor2;\tuniform vec4 laneColor1;\tuniform vec4 laneColor2;\tuniform vec4 grassColor1;\tuniform vec4 grassColor2;\tuniform vec4 grassColor3;\tuniform vec4 grassColor4;\tuniform vec4 sideColor1;\tuniform vec4 sideColor2;\tvec4 shadowColor=vec4(0.6,0.6,0.6,0.0);\t\tfloat pix=10.0;\tfloat seglength=400.0;\tfloat sidelength=60.0;\tbool isBorder(float x,float y){\t\tfloat xx=mod(x,pix*4.0)/pix;\t\tif(y*seglength<pix){\t\t\tif(xx<=1.0 || (xx>=2.0 && xx<=3.0)) return true;\t\t}else if(y*seglength<pix*2.0 && y*seglength>=pix){\t\t\tif(xx>=1.0 && xx<=2.0) return true;\t\t}else if(y*seglength>seglength-pix*2.0){\t\t\tif(y*seglength>seglength-pix){\t\t\t\tif(xx<=1.0) return true;\t\t\t}else{\t\t\t\tif(xx>=2.0 && xx<=3.0) return true;\t\t\t}\t\t}\t\treturn false;\t}\tvoid main(void){\t\tif(vColor<1.0){\t\t\tgl_FragColor=roadColor1;\t\t\tif(isBorder(vTextureCoord.x,vTextureCoord.z))\t\t\t\tgl_FragColor=roadColor2;\t\t\t\t\t}else if(vColor<2.0){\t\t\tgl_FragColor=roadColor2;\t\t\tif(isBorder(vTextureCoord.x,vTextureCoord.z))\t\t\t\tgl_FragColor=roadColor1;\t\t\t\t\t}else if(vColor<3.0){\t\t\tgl_FragColor=laneColor1;\t\t\tif(vTextureCoord.y*sidelength>sidelength-pix) gl_FragColor-=shadowColor/2.0;\t\t}else if(vColor<4.0){\t\t gl_FragColor=(vTextureCoord.y<.5)?grassColor1:grassColor3;\t\t if(isBorder(vTextureCoord.x,vTextureCoord.z))\t\t\t\tgl_FragColor=(vTextureCoord.y<.5)?grassColor2:grassColor4;\t\t}else if(vColor<5.0){\t\t gl_FragColor=(vTextureCoord.y<.5)?grassColor2:grassColor4;\t\t if(isBorder(vTextureCoord.x,vTextureCoord.z))\t\t\t\tgl_FragColor=(vTextureCoord.y<.5)?grassColor1:grassColor3;\t\t}else if(vColor<6.0){\t\t\tif(vTextureCoord.z<.33 ||vTextureCoord.z>.66) gl_FragColor=sideColor1;\t\t\telse gl_FragColor=sideColor2;\t\t\tif(vTextureCoord.y*sidelength>sidelength-pix) gl_FragColor-=shadowColor;\t\t}else if(vColor<7.0){\t\t\tif(vTextureCoord.z<.33 ||vTextureCoord.z>.66) gl_FragColor=sideColor2;\t\t\telse gl_FragColor=sideColor1;\t\t\tif(vTextureCoord.y*sidelength>sidelength-pix) gl_FragColor-=shadowColor;\t\t}else if(vColor<8.0){\t\t\tgl_FragColor=laneColor2;\t\t\tif(vTextureCoord.y*sidelength>sidelength-pix) gl_FragColor-=shadowColor/2.0;\t\t}\t}",yproj=[1,.67,.41,.24,.13,.07,.04,.032,.022,0],dk=[],theta_road=[.66,.97],RoadSpriteWScale=Math.tan(theta_road[1])-Math.tan(theta_road[0]),RoadSpriteXScale=Math.tan(theta_road[0]),theta_side=[1.21,1.29],SideSpriteWScale=Math.tan(theta_side[1])-Math.tan(theta_side[0]),SideSpriteXScale=Math.tan(theta_side[0]),Util={timestamp:function(){return(new Date).getTime()},toInt:function(e,t){if(null!==e){var o=parseInt(e,10);if(!isNaN(o))return o}return Util.toInt(t,0)},toFloat:function(e,t){if(null!==e){var o=parseFloat(e);if(!isNaN(o))return o}return Util.toFloat(t,0)},limit:function(e,t,o){return Math.max(t,Math.min(e,o))},randomInt:function(e,t){return Math.round(Util.interpolate(e,t,Math.random()))},randomChoice:function(e){return e[Util.randomInt(0,e.length-1)]},percentRemaining:function(e,t){return e%t/t},accelerate:function(e,t,o){return e+t*o},interpolate:function(e,t,o){return e+(t-e)*o},easeIn:function(e,t,o){return e+(t-e)*Math.pow(o,2)},easeOut:function(e,t,o){return e+(t-e)*(1-Math.pow(1-o,2))},easeInOut:function(e,t,o){return e+(t-e)*(-Math.cos(o*Math.PI)/2+.5)},exponentialFog:function(e,t){return 1/Math.pow(Math.E,e*e*t)},increase:function(e,t,o){for(var r=e+t;o<=r;)r-=o;for(;r<0;)r+=o;return r},project:function(e,t,o,r,n,a,s,i,l){t.camera.x=(t.world.x||0)-o,t.camera.y=(t.world.y||0)-r,t.camera.z=(t.world.z||0)-n;var c=Math.floor(e/segmentPerDraw),d=e/segmentPerDraw-c,g=Util.interpolate(dk[c],dk[Math.min(dk.length,c+1)],d);t.screen.scale=g/t.camera.z;var _=t.camera.x*g/t.camera.z,u=t.camera.y*g/t.camera.z;t.project.x=_,t.project.y=Math.abs(u),t.screen.x=Math.round(s/2+_*s/2),t.screen.y=Math.round(i*(1-RoadRatio)-u*i*RoadRatio),t.screen.w=Math.abs(u*l)},overlap:function(e,t,o,r,n){var a=(n||1)/2;return!(e+t*a<o-r*a||o+r*a<e-t*a)}};window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)});var _next_page,_driver_name,_guid,_isVender,Dom={get:function(e){return e instanceof HTMLElement||e===document?e:document.getElementById(e)},set:function(e,t,o){if("life"===e)for(var r=0;r<MaxLife;++r)(r<t?showItem:hideItem)(o.children().eq(r));else o.html(t)},on:function(e,t,o,r){Dom.get(e).addEventListener(t,o,r)},un:function(e,t,o,r){Dom.get(e).removeEventListener(t,o,r)},show:function(e,t){Dom.get(e).style.display=t||"block"},blur:function(e){e.target.blur()},addClassName:function(e,t){Dom.toggleClassName(e,t,!0)},removeClassName:function(e,t){Dom.toggleClassName(e,t,!1)},toggleClassName:function(e,t,o){var r=(e=Dom.get(e)).className.split(" "),n=r.indexOf(t);(o=void 0===o?n<0:o)&&n<0?r.push(t):!o&&0<=n&&r.splice(n,1),e.className=r.join(" ")},storage:window.localStorage||{}},Game={id:0,run:function(e){e.ready();var t=e.update,o=(e.render,e.step),r=null,n=Util.timestamp(),a=0,s=0;!function e(){for(r=Util.timestamp(),a=Math.min(1,(r-n)/1e3),s+=a;o<s;)s-=o,t(o);n=r,id=requestAnimationFrame(e)}()},stop:function(){cancelAnimationFrame(id)},setKeyListener:function(n){function t(e,t){for(var o,r=0;r<n.length;r++)(o=n[r]).mode=o.mode||"up",(o.key==e||o.keys&&0<=o.keys.indexOf(e))&&o.mode==t&&o.action.call()}Dom.on(document,"keydown",function(e){t(e.keyCode,"down")}),Dom.on(document,"keyup",function(e){t(e.keyCode,"up")})},playMusic:function(){var e=Dom.get("music");e.loop=!0,e.volume=.05,e.muted="true"===Dom.storage.muted,e.play(),Dom.toggleClassName("mute","on",e.muted),Dom.on("mute","click",function(){Dom.storage.muted=e.muted=!e.muted,Dom.toggleClassName("mute","on",e.muted)})}},KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,S:83,W:87},COLORS={SKY:"#72D7EE",TREE:"#005108",FOG:"#005108",LIGHT:{road:"#6B6B6B",grass:"#10AA10",rumble:"#555555",lane:"#CCCCCC"},DARK:{road:"#696969",grass:"#009A00",rumble:"#BBBBBB"},START:{road:"white",grass:"white",rumble:"white"},FINISH:{road:"black",grass:"black",rumble:"black"}},SPRITE_ROAD={COIN:["logo.png"],COMBO:["logo2-1.png","logo2-2.png"],COMBOGLOW:["logo2-2.png","logo2-2.png"],CONE1:["cone-1.png","cone-2.png","cone-3.png"],CONE2:["cone-2.png","cone-2.png","cone-3.png"],CONE3:["cone-3.png","cone-2.png","cone-3.png"],BLOCK1:["block-1.png","block-2.png","block-3.png"],BLOCK2:["block-2.png","block-2.png","block-3.png"],BLOCK3:["block-3.png","block-2.png","block-3.png"],LIGHT:["light-1.png","light-2.png","light-3.png"]},SPRITES1={TURNLEFT:["1-turn-left.png"],TURNRIGHT:["1-turn-right.png"],TREE1:["1-tree-1.png"],TREE2:["1-tree-2.png"],GRASS1:["1-grass1.png"],GRASS2:["1-grass2.png"],GRASS3:["1-grass3.png"],GRASS4:["1-grass4.png"],GRASS5:["1-grass5.png"],GRASS6:["1-grass6.png"],HOUSE1LEFT:["1-house1-left.png"],HOUSE2LEFT:["1-house2-left.png"],HOUSE1RIGHT:["1-house1-right.png"],HOUSE2RIGHT:["1-house2-right.png"],BOARD1:["1-board1.png"],BOARD2:["1-board2.png"],TOWER1:["1-tower1.png"],TOWER2:["1-tower2.png"]},SPRITES2={TURNLEFT:["2-turn-left.png"],TURNRIGHT:["2-turn-right.png"],BOARD1:["2-board1.png","2-board2.png"],BOARD2:["2-board2.png","2-board2.png"],BRIDGE:["2-bridge.png"],HOUSE3LEFT:["2-house3-left.png"],HOUSE4LEFT:["2-house4-left.png"],HOUSE5LEFT:["2-house5-left.png"],HOUSE6LEFT:["2-house6-left.png"],HOUSE3RIGHT:["2-house3-right.png"],HOUSE4RIGHT:["2-house4-right.png"],HOUSE5RIGHT:["2-house5-right.png"],HOUSE6RIGHT:["2-house6-right.png"],LIGHTLEFT:["2-light-left.png"],LIGHTRIGHT:["2-light-right.png"]},SPRITES3={TURNLEFT:["3-turn-left.png"],TURNRIGHT:["3-turn-right.png"],BOARD1:["3-board1.png"],BOARD2:["3-board2.png"],CHAIR1:["3-chair1.png"],CHAIR2:["3-chair2.png"],CHAIR3:["3-chair3.png"],HOUSE7:["3-house7.png"],UMBRELLA1:["3-umbrella1.png"],UMBRELLA2:["3-umbrella2.png"],UMBRELLA3:["3-umbrella3.png"],UMBRELLA4:["3-umbrella4.png"],TREE3LEFT:["3-tree3-left.png"],TREE4LEFT:["3-tree4-left.png"],TREE3RIGHT:["3-tree3-right.png"],TREE4RIGHT:["3-tree4-right.png"]},GATE={START:"start.png",GOAL:"goal.png"},OTHER_CAR=[{left:"other1-left.png",center:"other1-center.png",right:"other1-right.png"},{left:"other2-left.png",center:"other2-center.png",right:"other2-right.png"},{left:"other3-left.png",center:"other3-center.png",right:"other3-right.png"}],_cur_page="_home",_pre_page="_home",_driver_color="blue",_agree=!1,_trial_selected=!0,ClickBorder=.5,_inTransition=!1,RankCount=50;function closePage(e,t){switch(e){case"_home":"_rank"!==t&&hideItem($("#_button_rank")),"_campaign"===t&&$("#"+e).removeClass("pageToBase");break;case"_lottery":"_campaign"!==t&&(hideItem($("#_button_back")),$("#"+e).removeClass("pageToBase"));break;case"_rank":hideItem($("#_button_back")),$("#"+e).removeClass("pageToBase");break;case"_driver":"_color"===t&&($("#"+e).removeClass("pageToBase"),$("#"+e).addClass("pageToTop")),"_campaign"===t&&$("#"+e).removeClass("pageToTop");break;case"_color":"_game"===t&&($("#"+e).removeClass("pageToBase"),$("#"+e).removeClass("pageToBottom"),$("#"+e).addClass("pageToTop"),hideItem($("#_button_back"))),"_driver"===t&&$("#"+e).removeClass("pageToBase");break;case"_game":$("#_game").addClass("hidden"),"_home"===t?hideItem($("#_score")):(hideItem($("#_button_rank")),$("#"+e).addClass("pageToTop"),$("#_score").addClass("pageToTop"));break;case"_campaign":$("#_button_ok_campaign").removeClass("Click"),"_home"===t?hideItem($("#_button_back")):"_driver"!==t&&"_lottery"!==t||$("#"+e).removeClass("pageToBase")}}function setupPage(e){if("game"!==e)try{_sound_bgm.playing()||(_sound_bgm.play(),_sound_bgm.fade(0,1,2e3))}catch(e){console.log(e)}switch(e){case"_home":showItem($("#_button_control")),$("#_button_start").removeClass("Click"),$("#"+e).addClass("pageToBase"),$("#_campaign").hasClass("pageToBase")||$("#_campaign").addClass("pageToBase"),_game_elapse_time=-1,gtag("event","back"),gtag("event","Nav Click",{event_category:"Click",event_label:"back"});break;case"_driver":$("#_button_ok").removeClass("Click"),$("#_button_back").removeClass("Click"),$("#_input_driver").blur(),"_campaign"===_cur_page&&($("#_input_driver").val(""),_driver_name=""),"_color"===_cur_page&&$("#"+e).removeClass("pageToTop");break;case"_color":$("#_button_go").removeClass("Click"),$("#_button_back").removeClass("Click"),$("#"+e).addClass("pageToBase");break;case"_game":$("#_game").removeClass("hidden"),"_color"===_cur_page?(setupGame(),hideItem($("#_button_rank")),hideItem($("#_score")),movePage($("#_score_board"),"pageToTop"),showItem($("#_rule")),movePage($("#_rule_board"),"pageToTop"),$("#"+e).removeClass("pageToTop"),$("#_score").removeClass("pageToTop"),movePage($("#"+e),"pageFromBase")):(showItem($("#_button_rank")),$("#"+e).removeClass("pageToTop"),$("#_score").removeClass("pageToTop"));break;case"_rank":hideItem($("#_button_rank")),$("#_button_back").removeClass("Click"),$("#"+e).addClass("pageToBase");break;case"_lottery":"_game"===_cur_page&&clearInfo(),onClickGotoTrial(!1),$("#_button_send").removeClass("Click"),$("#_button_back").removeClass("Click"),hideItem($("#_button_rank")),$("#"+e).addClass("pageToBase"),gtag("event","Participate"),gtag("event","Nav Click",{event_category:"Click",event_label:"Participate"});break;case"_campaign":$("#_campaign_wrapper").scrollTop(0),$("#_campaign").hasClass("pageToBase")||$("#"+e).addClass("pageToBase")}}function needScroll(e){return e.parent().get(0).scrollHeight>e.parent().get(0).clientHeight}function gotoPage(e,t){if(_cur_page!==e&&!_inTransition){_inTransition=!0;try{switch(t){case"bb":_sound_fx.button_large.play();break;case"sb":_sound_fx.button_small.play()}}catch(e){console.log(e)}closePage(_cur_page,e),setupPage(e),_next_page=e,setTimeout(function(){onPageTransitionEnd()},500)}}function onPageTransitionEnd(){switch($("body").scrollTop(0),_inTransition=!1,_pre_page=_cur_page,_cur_page=_next_page,$("#_button_back").removeClass("Click"),_cur_page){case"_home":showItem($("#_button_rank")),$("#_driver").removeClass("pageToTop"),$("#_driver").addClass("pageToBase"),$("#_color").removeClass("pageToTop"),$("#_color").addClass("pageToBottom"),resetDriverColor();break;case"_driver":showItem($("#_button_back"));break;case"_color":break;case"_game":"_color"===_pre_page?(showItem($("#_rule")),movePage($("#_rule_board"),"pageFromTop"),hideItem($("#_button_control")),$("#_button_lottery").removeClass("Disable"),$("#_button_lottery").removeClass("Click")):(movePage($("#_score_board"),"pageFromBase"),hideItem($("#_button_control")));break;case"_lottery":showItem($("#_button_back")),$("#_button_send").removeClass("Disable"),$("#_button_send").removeClass("Click"),showItem($("#_button_control"));break;case"_rank":showItem($("#_button_back")),updateRank();break;case"_campaign":showItem($("#_button_back")),showItem($("#_button_control"))}}function hideItem(e){e.hasClass("hidden")&&e.hasClass("close")||(e.addClass("hidden"),setTimeout(function(){e.addClass("close")},600))}function showItem(e){(e.hasClass("hidden")||e.hasClass("close"))&&(e.removeClass("close"),setTimeout(function(){e.removeClass("hidden")},10))}function movePage(e,t,o){var r=t;setTimeout(function(){e.addClass(t)},100),setTimeout(function(){e.removeClass(r)},600)}function onButtonStartClick(){$("#_button_start").hasClass("Disable")||_inTransition||(gtag("event","CLICK_M_START"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_START"}),$("#_button_start").addClass("Click"),gotoPage("_campaign","bb"))}function onDriverNameClick(){_inTransition||(checkNameInput()?($("#_button_ok").addClass("Click"),setDriverName($("#_input_driver").val()),gotoPage("_color","bb")):_sound_fx.button_disable.play())}function setDriverName(e){_driver_name=e,$("#_driver_name_in_game").text(_driver_name),$("#_driver_name_complete").text(_driver_name)}function setDriverColor(e){_inTransition||e!==_driver_color&&(_sound_fx.button_small.play(),hideItem($("#_button_"+_driver_color+"_selected")),$("#_img_car_color_"+_driver_color).addClass("hidden"),$("#_img_car_color_"+_driver_color).addClass("close"),showItem($("#_button_"+e+"_selected")),$("#_img_car_color_"+e).removeClass("hidden"),$("#_img_car_color_"+e).removeClass("close"),$("#_car_complete").attr("src","asset/img/ui/frontcar_"+e+".png"),_driver_color=e)}function resetDriverColor(){var e="blue";$("#_button_"+_driver_color+"_selected").addClass("hidden"),$("#_button_"+_driver_color+"_selected").addClass("close"),$("#_img_car_color_"+_driver_color).addClass("hidden"),$("#_img_car_color_"+_driver_color).addClass("close"),$("#_button_blue_selected").removeClass("hidden"),$("#_button_blue_selected").removeClass("close"),$("#_img_car_color_"+e).removeClass("hidden"),$("#_img_car_color_"+e).removeClass("close"),$("#_car_complete").attr("src","asset/img/ui/frontcar_blue.png"),_driver_color=e}function onButtonGoClick(){_inTransition||($("#_button_go").addClass("Click"),gotoPage("_game","bb"))}function onButtonRuleOkClick(){_inTransition||(_sound_fx.button_large.play(),_sound_bgm.fade(1,0,2e3),hideItem($("#_rule")),showItem($("#_button_control")),setTimeout(function(){showItem($("#_hint"))},800))}function setDriverScore(e){$("#_score_complete").text(e)}function onButtonLotteryClick(){$("#_button_lottery").hasClass("Disable")||_inTransition||(gtag("event","CLICK_M_RESULT_NEXT"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_RESULT_NEXT"}),gotoPage("_lottery","bb"))}function onButtonHomeClick(){var e;_inTransition||(e="CLICK_M_COMPLETE_BACK",$("#_button_share").hasClass("hidden")&&(e="CLICK_M_RESULT_RETURN"),gtag("event",e),gtag("event","Nav Click",{event_category:"Click",event_label:e}),$("#_button_home").addClass("Click"),gotoPage("_home","bb"))}function showScore(){$("#_rank_to_show").addClass("hidden"),$("#_score").removeClass("pageToTop"),showItem($("#_score")),showItem($("#_button_rank")),$("#_button_home").removeClass("Click"),$("#_button_lottery").removeClass("Click"),$("#_button_lottery").removeClass("Disable"),showItem($("#_button_lottery")),hideItem($("#_button_share")),hideItem($("#_button_the2")),hideItem($("#_button_control")),setTimeout(function(){movePage($("#_score_board"),"pageFromTop")},100)}function clearInfo(){$("#_input_lottery_name").val(""),$("#_input_lottery_gender").val("男"),$("#_input_lottery_age").val("20-"),$("#_input_lottery_phone").val(""),$("#_input_lottery_email").val(""),$("#_button_goto_trial_yes").removeClass("checked"),$("#_button_goto_trial_no").addClass("checked"),$("#_input_lottery_score").val("台北汎德 - 天母"),_agree=!1,$("#_button_agree").removeClass("checked"),$("#_lottery_input_error").text(""),toggleLotteryError(!1)}function sendInfo(o){var e;$("#_button_send").hasClass("Disable")||_inTransition||(checkLotteryInput()?(gtag("event","CLICK_M_FORM_COMPLETE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_FORM_COMPLETE"}),toggleLotteryError(_inTransition=!0,"傳送中..."),$("#_button_send").addClass("Click"),_sound_fx.button_large.play(),e={player:_driver_name,color:_driver_color,score:score,name:$("#_input_lottery_name").val(),gender:$("#_input_lottery_gender").val(),age:$("#_input_lottery_age").val(),phone:$("#_input_lottery_phone").val(),email:$("#_input_lottery_email").val(),trial:_trial_selected,store:$("#_input_lottery_store").val(),vender:_isVender?"TRUE":""},$.ajax({url:"https://script.google.com/macros/s/AKfycbxPGSHSW3HBjJ4WPmAXtTgUX2SKa6t0lH7M4zwQTcOYKaXGzzE9/exec",data:e,success:function(e){console.log("update info: "+e);var t=JSON.parse(e);_inTransition=!1,"success"===t.result?(toggleLotteryError(!0,"成功!"),gtag("event","complete"),gtag("event","Nav Click",{event_category:"Click",event_label:"complete"}),_rank=t.rank,$("#_rank_complete").text(_rank),$("#_rank_to_show").removeClass("hidden"),$("#_button_send").addClass("Disable"),_guid=t.uid,hideItem($("#_button_lottery")),$("#_button_share").removeClass("Click"),showItem($("#_button_share")),showItem($("#_button_the2")),setTimeout(function(){o&&o(),gotoPage("_game","bb")},300)):($("#_button_send").removeClass("Click"),$("#_button_send").removeClass("Disable"),toggleLotteryError(!0,"something wrong^^"))},error:function(e,t,o){alert("something wrong^^"),console.log(e)}})):_sound_fx.button_disable.play())}function onButtonBackClick(){if(!_inTransition)switch($("#_button_back").addClass("Click"),_cur_page){case"_rank":gotoPage(_pre_page,"sb");break;case"_driver":gotoPage("_campaign","sb");break;case"_color":gotoPage("_driver","sb");break;case"_lottery":gotoPage("_game","sb");break;case"_campaign":"_lottery"===_pre_page&&gotoPage("_lottery","sb"),"_home"!==_pre_page&&"_driver"!==_pre_page||gotoPage("_home","sb")}}function onGameClick(e){var t;e.preventDefault(),isPlaying&&((t=e.offsetX/width)<ClickBorder?keyLeft=!0:1-ClickBorder<t&&(keyRight=!0))}function onGameMouseUp(e){e.preventDefault(),keyRight=keyLeft=0}function onClickGotoTrial(e){e?($("#_button_goto_trial_yes").addClass("checked"),$("#_button_goto_trial_no").removeClass("checked"),fbq("track","Lead")):($("#_button_goto_trial_yes").removeClass("checked"),$("#_button_goto_trial_no").addClass("checked")),_trial_selected=e}function onClickAgree(){_agree=$("#_button_agree").hasClass("checked")?($("#_button_agree").removeClass("checked"),!1):($("#_button_agree").addClass("checked"),!0)}function updateRank(s){var e={count:RankCount};$.ajax({url:"https://script.google.com/macros/s/AKfycbzQIXck9QaCW1k5VmgW6WFOm5yQ35K2ULryaW8ilJ4K-uadGCI/exec",data:e,success:function(e){$("#_rank_info").empty();var t=JSON.parse(e),o=1;for(var r in t){var n=t[r];if(""===n[2])break;var a=$("<div></div>");$("<sapn></span>").text(o+".").appendTo(a),$("<sapn></span>").text(n[0]).appendTo(a),$("<sapn></span>").text(n[2]).appendTo(a),a.addClass("RankItem"),a.appendTo($("#_rank_info")),o++}console.log("update rank!"),s&&s()},error:function(e,t,o){alert("something wrong^^"),console.log(e)}})}function checkNameInput(){var e="";return $("#_input_driver").val().length<1&&(e+="*不可空白"),$("#_input_driver").val($("#_input_driver").val().replace(/ /g,"").toUpperCase()),toggleNameError(0<e.length,e),0==e.length}function toggleNameError(e,t){e?($("#_driver_input_error").text(t),$("#_driver_input_error").removeClass("hidden"),$("#_button_ok").addClass("Disabled")):($("#_driver_input_error").addClass("hidden"),$("#_button_ok").removeClass("Disabled"))}function checkLotteryInput(){var e="";$("#_input_lottery_name").val().length<1&&(e+="*姓名不可空白\n");var t=$("#_input_lottery_phone").val();return(t.length<12||!/^09\d{2}-\d{3}-\d{3}$/.test(t))&&(e+="*手機格式錯誤\n"),$("#_input_lottery_email").val().toLowerCase().length<1&&(e+="*email不可空白"),_agree||(e+="*請同意個人資料使用"),toggleLotteryError(0<e.length,e),0==e.length}function toggleLotteryError(e,t){e?($("#_lottery_input_error").text(t),$("#_lottery_input_error").removeClass("hidden"),$("#_button_ok").addClass("Disabled")):($("#_lottery_input_error").addClass("hidden"),$("#_button_ok").removeClass("Disabled"))}function getUrlParameter(){new URL(window.location.href);_isVender=get("vender"),console.log("vender= "+_isVender)}function get(e){if(e=new RegExp("[?&]"+encodeURIComponent(e)+"=([^&]*)").exec(location.search))return decodeURIComponent(e[1])}function onButtonCampaignOkClick(){_inTransition||($("#_button_ok_campaign").addClass("Click"),"_lottery"===_pre_page?gotoPage("_lottery","sb"):gotoPage("_driver","bb"))}function onClickCampaignInfo(){_inTransition||(gtag("event","CLICK_M_FORM_MORE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_FORM_MORE"}),gotoPage("_campaign","bb"))}function isIpad(){var e=window.navigator.userAgent;if(-1<e.indexOf("iPad"))return!0;if(-1<e.indexOf("Macintosh"))try{return document.createEvent("TouchEvent"),!0}catch(e){}return!1}function onSoundButtonClick(){Howler._muted?(Howler.mute(!1),$("#_button_sound").attr("src","asset/img/ui/button_sound_on.png")):(Howler.mute(!0),$("#_button_sound").attr("src","asset/img/ui/button_sound_off.png"))}function onContinueButtonClick(){_sound_fx.button_small.play(),hideItem($("#_control")),"_game"===_cur_page&&resumeGame()}function onExitButtonClick(){_sound_fx.button_small.play(),hideItem($("#_control")),isPlaying&&exitGame(),gotoPage("_home")}function onButtonControlClick(){_sound_fx.button_small.play(),$("#_control").hasClass("hidden")?(pauseGame(),showItem($("#_control"))):(resumeGame(),hideItem($("#_control")))}function onButtonShareClick(){var e;_inTransition||(gtag("event","CLICK_M_COMPLETE_SHARE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_COMPLETE_SHARE"}),_sound_fx.button_large.play(),$("#_button_share").addClass("Click"),_inTransition=!0,(e=new FormData).append("action","get_share_url"),e.append("guid",_guid),e.append("name",_driver_name),e.append("color",_driver_color),e.append("score",score),e.append("rank",_rank),$.ajax({url:"https://event.bmw.com.tw/campaign/2020/the2_racing_challenge/m/src/php/action.php",type:"POST",data:e,processData:!1,contentType:!1,cache:!1,success:function(e){_inTransition=!1,console.log(e),window.location.href=e.share_url},error:function(e,t,o){_inTransition=!1,console.log(e)}}))}function onButtonThe2Click(){gtag("event","CLICK_M_COMPLETE_EVENTSITE"),gtag("event","Nav Click",{event_category:"Click",event_label:"CLICK_M_COMPLETE_EVENTSITE"}),window.open("https://event.bmw.com.tw/campaign/2020/2series-gran-coupe/?utm_source=THE2RACINGCHALLENGE","_blank")}getUrlParameter();var totalCombos=[10,20,30],totalObstacles=[5,12,15],ROAD_SCALE=5,SPRITE_ROAD_TAG={COIN:["COIN"],COMBO:["COMBO"],CONE:["CONE1","CONE2","CONE3"],BLOCK:["BLOCK1","BLOCK2","BLOCK3"],LIGHT:["LIGHT1","LIGHT2","LIGHT3"]},SPRITES1_TAG={TURN:{left:["TURNLEFT"],right:["TURNRIGHT"]},TREE:["TREE1","TREE2"],GRASS:["GRASS1","GRASS2","GRASS3","GRASS4","GRASS5","GRASS6"],HOUSE:{left:["HOUSE-1LEFT","HOUSE-2LEFT"],right:["HOUSE1RIGHT","HOUSE2LEFT"]},BOARD:["BOARD1","BOARD2"],TOWER:["TOWER1","TOWER2"]},SPRITES2_TAG={TURN:{left:["TURNLEFT"],right:["TURNRIGHT"]},BOARD:["BOARD1","BOARD2"],BRIDGE:["BRIDGE"],HOUSE:{left:["HOUSE3LEFT","HOUSE4LEFT","HOUSE5LEFT","HOUSE6LEFT"],right:["HOUSE3RIGHT","HOUSE4RIGHT","HOUSE5RIGHT","HOUSE6RIGHT"]},LIGHT:{left:["LIGHTLEFT"],right:["LIGHTRIGHT"]}},SPRITES3_TAG={TURN:{left:["TURNLEFT"],right:["TURNRIGHT"]},BOARD:["BOARD1","BOARD2"],CHAIR:["CHAIR1","CHAIR2","CHAIR3"],HOUSE:{left:["HOUSE7"],right:[]},UMBRELLA:["UMBRELLA1","UMBRELLA1","UMBRELLA1","UMBRELLA1"],TREE:{left:["TREE3LEFT","TREE4LEFT"],right:["TREE3RIGHT","TREE4RIGHT"]}};function generateMap(){resetSprites(),resetCoins(),resetObstacles(),resetCars()}function resetSprites(){for(var e=startGateZ/segmentLength,t=0;t<totalScene;++t)for(var o=t<1?0:sceneSegment[t-1],r=sceneSegment[t],n=[Math.round(Math.random()*(t<1?5:4)),Math.round(Math.random()*(t<1?5:4))],a=o;a<r;++a)if(a%(segmentPerDraw/2)==0&&!(a<e))for(var s=0;s<2;++s){var i,l=sidePosition[s];1<10*Math.random()&&((i=getRandomSprite(t,n[s],l))===SPRITES2.BRIDGE[0]&&(l=0),null!=i&&addSprite(a,i,l)),5*Math.random()<1&&(n[s]=Math.round(Math.random()*(t<1?5:4)))}}function getRandomSprite(e,t,o){var r=null;switch(e){case 0:switch(t){case 0:r=SPRITES1_TAG.TREE[Math.round(2*Math.random())];break;case 1:r=SPRITES1_TAG.GRASS[Math.round(4*Math.random())];break;case 2:r=o<0?SPRITES1_TAG.HOUSE.left[Math.round(2*Math.random())]:SPRITES1_TAG.HOUSE.right[Math.round(2*Math.random())];break;case 3:r=SPRITES1_TAG.BOARD[Math.round(2*Math.random())];break;case 4:r=SPRITES1_TAG.TOWER[Math.round(2*Math.random())]}break;case 1:switch(t){case 0:r=SPRITES2_TAG.BRIDGE[0];break;case 1:r=o<0?SPRITES2_TAG.HOUSE.left[Math.round(4*Math.random())]:SPRITES2_TAG.HOUSE.right[Math.round(4*Math.random())];break;case 2:r=SPRITES2_TAG.BOARD[Math.round(2*Math.random())];break;case 3:r=o<0?SPRITES2_TAG.LIGHT.left[0]:SPRITES2_TAG.LIGHT.right[0]}break;case 2:switch(t){case 0:r=SPRITES3_TAG.CHAIR[Math.round(3*Math.random())];break;case 1:o<0&&(r=SPRITES3_TAG.HOUSE.left[0]);break;case 2:r=SPRITES3_TAG.BOARD[Math.round(2*Math.random())];break;case 3:r=SPRITES3_TAG.UMBRELLA[Math.round(4*Math.random())];break;case 4:r=o<0?SPRITES3_TAG.TREE.left[Math.round(2*Math.random())]:SPRITES3_TAG.TREE.right[Math.round(2*Math.random())]}}return r}function resetCars(){var e,t,o,r,n=startGateZ/segmentLength;cars=[];for(var a=0;a<totalScene;++a)for(var s=a<1?n:sceneSegment[a-1],i=(a==totalScene-1?-n:0)+sceneSegment[a],l=0;l<totalCars[a];l++)t=Util.randomChoice(onRoadPosition),o=Math.floor(Math.random()*(i-s)+s)*segmentLength,r=Math.floor(3*Math.random()),findSegment((e={offsetX:t,offsetY:0,z:o,source:t<0?OTHER_CAR[r].left:0<t?OTHER_CAR[r].right:OTHER_CAR[r].center,speed:sceneSpeedRatio[a]/2+Math.random()*BaseSpeed,color:r}).z).cars.push(e),cars.push(e)}function resetCoins(){for(var e=startGateZ/segmentLength,t=0;t<totalScene;++t){for(var o=t<1?e:sceneSegment[t-1],r=sceneSegment[t],n=totalCoins[t]+totalCombos[t],a=[],s=o;s<r;++s)s%(segmentPerDraw/2)==0&&a.push(s);shuffleArray(a);var i=(a=a.slice(0,n)).slice(0,totalCombos[t]);a.sort(function(e,t){return e-t});for(var l=Math.floor(Math.random()*onRoadPosition.length),c=0,s=0;s<a.length&&c<n;++s){Math.random()*(1+totalScene-t)<1&&(l=Math.floor(Math.random()*onRoadPosition.length));for(var d=2*Math.random()<1?1:Math.floor(2*Math.random()+1),g=0;g<d;++g){var _={offsetX:onRoadPosition[(l+g)%3],offsetY:0,source:-1<i.indexOf(a[s])?"COMBO":"COIN",score:-1<i.indexOf(a[s])?5:1};segments[a[s]].coins.push(_),c++}}console.log(c+" coins added!")}}function resetObstacles(){for(var e=startGateZ/segmentLength,t=0;t<totalScene;++t){for(var o=t<1?e:sceneSegment[t-1],r=sceneSegment[t],n=totalObstacles[t],a=[],s=o;s<r;++s)s%(segmentPerDraw/2)==0&&a.push(s);shuffleArray(a);for(var i=0,s=0;s<n;++s){for(var l,c=[],d=0;d<onRoadPosition.length;++d){var g=onRoadPosition[d];if(!segmentHasCoin(a[s],g)){for(var _=0;_<segmentPerDraw/2;++_)segmentHasCoin(a[s]-_,g)||segmentHasCoin(a[s]+_,g);c.push(onRoadPosition[d]);break}}c.length<1||(l={offsetX:Util.randomChoice(c),offsetY:0,source:2*Math.random()<1?"CONE-"+(t+1):"BLOCK-"+(t+1)},segments[a[s]].obstacles.push(l),i++)}console.log(i+" obstacles added!")}}function segmentHasCoin(e,t){if(e<0||e>segments.length-1)return!1;for(var o=segments[e],r=0;r<o.coins.length;++r)if(o.coins[r].offsetX==t)return!0;return!1}function shuffleArray(e){for(var t=e.length-1;0<t;t--){var o=Math.floor(Math.random()*(t+1)),r=e[t];arr[t]=arr[o],arr[o]=r}}function printMap(){for(var e="",t=0;t<segments.length;++t)if(t%(segmentPerDraw/2)==0){var o=segments[t];e+=o.index+",";for(var r=null,n=null,a=0;a<o.sprites.length;++a)o.sprites[a].offset<0?r=o.sprites[a]:n=o.sprites[a];for(var s=null,i=null,l=null,a=0;a<o.coins.length;++a)o.coins[a].offsetX<0?s=o.coins[a]:0<o.coins[a].offsetX?l=o.coins[a]:i=o.coins[a];for(a=0;a<o.obstacles.length;++a)o.obstacles[a].offsetX<0?s=o.obstacles[a]:0<o.obstacles[a].offsetX?l=o.obstacles[a]:i=o.obstacles[a];e+=null!==r?r.source+",":",",e+=null!==s?s.source+",":",",e+=null!==i?i.source+",":",",e+=null!==l?l.source+",":",",e+=null!==n?n.source+"\n":"\n"}console.log(e),window.open("data:text/csv;charset=utf-8,"+escape(e))}function readMap(e,t){$.ajax({type:"GET",url:e,dataType:"text",success:function(e){processData(e),t()}})}function processData(e){for(var t=e.split(/\r\n|\n/),o=[],r=1;r<t.length;r++){if(6<=(e=t[r].split(",")).length){for(var n=[],a=0;a<6;a++)n.push(e[a]);o.push(n)}}ROAD_SCALE=sceneSegment[2]/o.length,cars=[];for(var s=0;s<o.length;++s){var i=Math.floor(o[s][0]*ROAD_SCALE);if(!(i>=sceneSegment[2])){var l,c,d=i<sceneSegment[0]?0:i<sceneSegment[1]?1:2,g=segments[i],_=i>=sceneSegment[1]?(l=SPRITES3,i/(sceneSegment[2]-sceneSegment[1])):i>=sceneSegment[0]?(l=SPRITES2,i/(sceneSegment[1]-sceneSegment[0])):(l=SPRITES1,i/sceneSegment[0]),u=o[s][1];try{0<u.length&&void 0!==l[u]&&(c=l[u][0],g.sprites.push({source:c,offset:"BRIDGE"===u?0:sidePosition[0]})),0<(u=o[s][5]).length&&void 0!==l[u]&&(c=l[u][0],g.sprites.push({source:c,offset:"BRIDGE"===u?0:sidePosition[1]})),l=SPRITE_ROAD;for(var p,m,f,h,C=2;C<5;++C){(u=o[s][C]).length<1||("CAR"!==u?void 0!==l[u]&&(c=l[u][0],"COIN"===u||"COMBO"===u?g.coins.push({source:c,offsetX:onRoadPosition[C-2],offsetY:0,score:"COIN"===u?1:5}):g.obstacles.push({source:c,offsetX:onRoadPosition[C-2],offsetY:0})):(p=i*segmentLength,m=Math.floor(3*Math.random()),f=onRoadPosition[C-2]<0?OTHER_CAR[m].left:0<onRoadPosition[C-2]?OTHER_CAR[m].right:OTHER_CAR[m].center,h=Util.interpolate(sceneSpeedRatio[d],sceneSpeedRatio[1+d],_+.01)*BaseSpeed,car={offsetX:onRoadPosition[C-2],offsetY:0,z:p,source:f,speed:h,color:m,index:cars.length,segment:i,playsound:!1},g.cars.push(car),cars.push(car)))}}catch(e){console.log(e)}}}}for(var Render={polygon:function(e,t,o,r,n,a,s,i,l,c,d,g){var _,u,p=_road.getChildAt(e);p&&(p.geometry.getBuffer("aVertexPosition").update(new Float32Array([t,o,r,n,a,s,i,l])),_=p.geometry.getBuffer("aTextureCoord"),u=1/segmentPerDraw,parseFloat(Math.floor(e/PolyPerSeg)%segmentPerDraw),_.update(new Float32Array([c,d+u,c,d,c+.5,d,c+.5,d+u])))},segment:function(e,t,o,r,n,a,s,i,l,c,d){var g,_,u,p,m=Render.rumbleWidth(a,o),f=Render.rumbleWidth(l,o),h=Render.laneMarkerWidth(a,o),C=Render.laneMarkerWidth(l,o),v=e%drawDistance,R=e%segmentPerDraw/segmentPerDraw,S=Math.floor(e/segmentPerDraw)%2;Render.polygon(v*PolyPerSeg,0,i,0,n,2*offset_width+t,n,2*offset_width+t,i,3+S,R,d),Render.polygon(v*PolyPerSeg+1,offset_width+s-l-f,i,offset_width+r-a-m,n,offset_width+r-a,n,offset_width+s-l,i,5+S,R,d),Render.polygon(v*PolyPerSeg+2,offset_width+s+l+f,i,offset_width+r+a+m,n,offset_width+r+a,n,offset_width+s+l,i,5+S,R,d),Render.polygon(v*PolyPerSeg+3,offset_width+s-l,i,offset_width+r-a,n,offset_width+r+a,n,offset_width+s+l,i,S,R,d),(v+segmentPerDraw/2)%(2*segmentPerDraw)<segmentPerDraw&&(u=r-a+(g=2*a/o),p=s-l+(_=2*l/o),Render.polygon(v*PolyPerSeg+4,offset_width+p-C/2,i,offset_width+u-h/2,n,offset_width+u+h/2,n,offset_width+p+C/2,i,2,R,d),Render.polygon(v*PolyPerSeg+5,offset_width+p-_+C-C/2,i,offset_width+u-g+h-h/2,n,offset_width+u-g+h+h/2,n,offset_width+p-_+C+C/2,i,7,R,d),u+=g,p+=_,Render.polygon(v*PolyPerSeg+6,offset_width+p+C/2,i,offset_width+u+h/2,n,offset_width+u-h/2,n,offset_width+p-C/2,i,2,R,d),Render.polygon(v*PolyPerSeg+7,offset_width+p+_-C+C/2,i,offset_width+u+g-h+h/2,n,offset_width+u+g-h-h/2,n,offset_width+p+_-C-C/2,i,7,R,d)),Render.fog(0,n,t,i-n,c)},background:function(e,t,o,r,n,a){r=r||0,a=a||0;e.texture.width,e.texture.height;var s=Math.floor(e.texture.width*r);e.tilePosition.x=-s,e.tilePosition.y=-a*(e.texture.height*e.tileScale.y-e.height)},sprite:function(e,t,o,r,n,a,s){var i,l;void 0!==t&&(s=s||1,o-=(i=(e.texture=t).width*n)/2,r-=l=t.height*n,e.x=o,e.y=r,e.width=i,e.height=l,e.zIndex=a,e.alpha=s,e.visible=!0)},trafficLight:function(e,t,o,r,n){if(e){var a=1766*r,s=626*r;t-=a/2,o-=s;for(var i=[.11,.91],l=[.44,.55,.66],c=0;c<2;++c)for(var d=0;d<3;++d){var g=e.getChildAt(3*c+d);g.x=t+i[c]*a,g.y=o+l[d]*s,g.height=g.width=54*r,g.zIndex=n+1}e.zIndex=n+1}},player:function(e,t,o,r,n,a){Math.random(),Util.randomChoice([-1,1]);var s=a<0?"right":0<a?"left":"center";_last_car_pos!=s&&(_car.textures=_car_texture_arr[s],_car.gotoAndPlay(0)),_last_car_pos=s;var i=_car.texture.width*o,l=_car.texture.height*o;r-=i/2,n-=l;_car.x=r,_car.y=n,_car.width=i,_car.height=l},fog:function(e,t,o,r,n){},rumbleWidth:function(e,t){return e/Math.max(6,2*t)},laneMarkerWidth:function(e,t){return e/Math.max(24,6*t)}},fps=60,step=1/fps,width=null,height=null,offset_width=null,centrifugal=.3,offRoadDecel=.99,skySpeed=.001,hillSpeed=.002,treeSpeed=.003,skyOffset=0,hillOffset=0,treeOffset=0,segments=[],cars=[],background=null,sprites=null,resolution=null,roadWidth=2191,segmentLength=1e3,rumbleLength=3,trackLength=null,lanes=3,fieldOfView=134,cameraHeight=1e3,cameraDepth=null,drawDistance=40,mDrawSegment=8,segmentPerDraw=Math.floor(drawDistance/mDrawSegment),spritePerDraw=drawDistance,playerX=0,playerZ=8*segmentLength,fogDensity=5,position=0,speed=0,accel=0,lastPlayerSegment=0,indexScene=0,totalScene=3,sceneInterval=[25,20,15],sceneLapsedInterval=[],tmp=0,i=0;i<totalScene;++i)tmp+=sceneInterval[i],sceneLapsedInterval.push(tmp);for(var sceneSpeedRatio=[0,1.25,1.5,2],lengthScene=200,BaseSpeed=lengthScene*segmentLength/(sceneInterval[0]*(sceneSpeedRatio[0]+sceneSpeedRatio[1])/2),isPlaying=!1,maxSpeed=BaseSpeed*sceneSpeedRatio[sceneSpeedRatio.length-1],sceneSegment=[],tmp=0,i=0;i<totalScene;++i){var len=.5*BaseSpeed*(sceneSpeedRatio[i]+sceneSpeedRatio[i+1])*sceneInterval[i];tmp+=Math.ceil(len/segmentLength),sceneSegment.push(tmp)}var score=0,MaxLife=3,life=MaxLife,totalCars=[5,8,12],sidePosition=[-2,2,0],onRoadPosition=[-1,0,1],CoinFlyVel=.1,CoinScale=.82,ObstacleScale=1.12,startGateZ=19*segmentLength,endGateZ=19*segmentLength,currentLapTime=0,lastLapTime=null,keyLeft=!1,keyRight=!1,keyFaster=!1,keySlower=!1,hud=null;function update(e){var t,o,r;0<=_game_elapse_time&&(_game_elapse_time+=e);var n=findSegment(position+playerZ);isPlaying?(position=Math.min(position+e*speed,trackLength),speed=speed<BaseSpeed?Math.min(speed+e*accel*5,sceneSpeedRatio[indexScene+1]*BaseSpeed):Math.min(speed+e*accel,sceneSpeedRatio[indexScene+1]*BaseSpeed),currentLapTime+=e):(position=Math.min(position+e*speed,trackLength),speed=Math.max(speed-80*accel*e,0)),updateCars(e,n,m),n.index>sceneSegment[indexScene]?indexScene<totalScene-1?setupScene(indexScene+1):(_ribbon.visible=!0,endGame()):0==indexScene&&_game_elapse_time<4&&1<=_game_elapse_time&&(2<=_game_elapse_time?3<=_game_elapse_time?isPlaying||(isPlaying=!0,_car.gotoAndPlay(0),_sound_game.play(),_sound_game.fade(.5,1,1e3),_sound_game.seek(0)):setTrafficLight(2):setTrafficLight(1));var a=Math.min(position,sceneSegment[2]*segmentLength-endGateZ),s=findSegment(a),i=Util.percentRemaining(a,segmentLength),l=Util.percentRemaining(position+playerZ,segmentLength*segmentPerDraw),c=Util.interpolate(n.p1.world.y,n.p2.world.y,l),d=0,g=-s.curve*i;for(v=0;v<drawDistance;v++){segment=segments[(s.index+v)%segments.length],segment.looped=segment.index<s.index,segment.fog=Util.exponentialFog(v/drawDistance,fogDensity);var _=playerX*roadWidth*2;Util.project(v,segment.p1,_-d,c+cameraHeight,a,cameraDepth,width,height,roadWidth),Util.project(v+1,segment.p2,_-d-g,c+cameraHeight,a,cameraDepth,width,height,roadWidth),d+=g,g+=segment.curve;for(var u=0;u<segment.coins.length;u++)0<segment.coins[u].offsetY&&(segment.coins[u].offsetY=Math.min(segment.coins[u].offsetY+CoinFlyVel,1));for(u=0;u<segment.obstacles.length;u++)0<segment.obstacles[u].offsetY&&(segment.obstacles[u].offsetY=Math.min(segment.obstacles[u].offsetY+CoinFlyVel,1))}for(u=0;u<cars.length;u++)0<cars[u].offsetY&&(cars[u].offsetY=Math.min(cars[u].offsetY+CoinFlyVel,1));var p,m=_car.textures[0].width*CarScale,f=2*e*Math.min(2,speed/BaseSpeed*4),h=position;if(keyLeft?playerX-=f:keyRight&&(playerX+=f),playerX=Util.limit(playerX,onRoadPosition[0],onRoadPosition[2]),isPlaying){if(lastPlayerSegment!=n.index){for(var C=segments[n.index],v=(C.p1.project.y,RoadRatio,SpriteScale,0);v<C.coins.length;v++)o=C.coins[v],r=.5,Util.overlap(playerX,.5,o.offsetX,r)&&(score+=C.coins[v].score,o.offsetY+=CoinFlyVel,1<C.coins[v].score?_sound_fx.combo.play():_sound_fx.coin.play());for(v=0;v<C.obstacles.length;v++)if(o=C.obstacles[v],r=.5,Util.overlap(playerX,.5,o.offsetX,r)){--life,o.offsetY+=CoinFlyVel,_sound_fx.bump.play(),life<=0&&endGame(!0);break}}for(v=0;v<cars.length;v++)if(t=cars[v],!(Math.abs(t.segment-n.index)>drawDistance)){if(t.offsetY<=0&&t.segment==n.index&&Util.overlap(playerX,.5,t.offsetX,.5)){--life,t.offsetY+=CoinFlyVel,_sound_fx.bump.play(),life<=0&&endGame(!0);break}t.playSound||(2*Math.random()<1?_sound_fx.other_car.play():_sound_fx.horn.play(),t.playSound=!0)}}skyOffset=Util.increase(skyOffset,skySpeed*n.curve*(position-h)/segmentLength,1),hillOffset=Util.increase(hillOffset,hillSpeed*n.curve*(position-h)/segmentLength,1),treeOffset=Util.increase(treeOffset,treeSpeed*n.curve*(position-h)/segmentLength,1),lastPlayerSegment=n.index,0<indexScene&&((p=s.index-sceneSegment[indexScene-1])<=40&&setShaderUniforms(indexScene-1,indexScene,Math.min(1,p/30))),updateHud()}function updateCars(e,t,o){for(var r,n,a,s=0;s<cars.length;s++)r=cars[s],n=segments[r.segment],r.segment<t.index||r.segment-t.index>drawDistance||(r.offsetX=r.offsetX+updateCarOffset(r,r.segment,t,o),r.offsetX=Util.limit(r.offsetX,onRoadPosition[0],onRoadPosition[2]),r.z=Util.increase(r.z,e*speed*.6,trackLength),r.percent=Util.percentRemaining(r.z,segmentLength),a=findSegment(r.z),r.segment=a.index,n!=a&&(index=n.cars.indexOf(r),n.cars.splice(index,1),a.cars.push(r)))}function updateCarOffset(e,t,o,r){for(var n,a,s=Math.min(2,e.speed/BaseSpeed*4),i=[!1,!1,!1],l=1;l<10;l++)for(var c,d=segments[(t+l)%segments.length],g=0;g<d.obstacles.length;++g)(c=d.obstacles[g]).offsetX<0?i[0]=!0:0<c.offsetX?i[2]=!0:i[1]=!0;for(n=0;n<cars.length;n++)(a=cars[n]).index!=e.index&&a.segment>e.segment&&a.segment<e.segment+10&&(a.offsetX<0?i[0]=!0:0<a.offsetX?i[2]=!0:i[1]=!0);var _=Util.limit(Math.floor(e.offsetX+1),0,2);if(0==_&&i[0])return s;if(2==_&&i[2])return-s;if(1==_&&i[1]){if(!i[0])return-s;if(!i[2])return s;speed=0}return 0}function updateHud(){var e=Util.interpolate(0,200,speed/maxSpeed);updateHudElement("speed",Math.round(e));var t=Util.interpolate(-65,135,e/200);$("#_speed_pointer").css("transform","rotate("+t+"deg)");var o=playerZ/segmentLength;updateHudElement("time",formatTime(sceneLapsedInterval[totalScene-1]*Math.max(0,1-(lastPlayerSegment-o)/(sceneSegment[totalScene-1]-o)))),updateHudElement("life",Math.max(0,life)),updateHudElement("score",pad(score,3))}function updateHudElement(e,t){hud[e].value!==t&&(hud[e].value=t,Dom.set(e,t,hud[e].dom))}function formatTime(e){var t=Math.floor(e),o=Math.floor(100*(e-Math.floor(e)));return pad(t,2)+":"+pad(o,2)}function pad(e,t,o){return o=o||"0",(e+="").length>=t?e:new Array(t-e.length+1).join(o)+e}function render(){var e,t,o,r,n,a,s,i,l,c=Math.min(position,sceneSegment[2]*segmentLength-endGateZ),d=findSegment(c),g=(Util.percentRemaining(c,segmentLength),findSegment(position+playerZ)),_=Util.percentRemaining(position+playerZ,segmentLength),u=Util.interpolate(g.p1.world.y,g.p2.world.y,_),p=height;for(Render.background(_sky,width,height,skyOffset,resolution*skySpeed*u,d.index/sceneSegment[totalScene-1]),_mountain.x=_dest_mountain*(g.index/sceneSegment[2]),e=0;e<_scene_road.children.length;++e)_scene_road.getChildAt(e).visible=!1;for(e=0;e<_scene_side.children.length;++e)_scene_side.getChildAt(e).visible=!1;for(e=0;e<_other_car.children.length;++e)_other_car.getChildAt(e).visible=!1;for(_start_gate.visible=!1,e=0;e<drawDistance;e++)d.index+e>segments.length-1||(t=segments[d.index+e]).p1.camera.z<=cameraDepth||t.p2.screen.y>=t.p1.screen.y||t.p2.screen.y>=p||(Render.segment(Math.round(d.index+e),width,lanes,t.p1.screen.x,t.p1.screen.y,t.p1.screen.w,t.p2.screen.x,t.p2.screen.y,t.p2.screen.w,t.fog,t.scene),p=t.p1.screen.y);for(e=0;e<drawDistance;++e)if(!(d.index+e>segments.length-1)){t=segments[d.index+e];for(var m,f,h,C=(d.index+e)%drawDistance,v=findSegmentScene(t.index),R=[!1,!1,!1],S=0;S<t.sprites.length;S++){r=t.sprites[S],I=t.p1.project.y*height*RoadRatio*SideSpriteXScale*SpriteScale,M=offset_width+t.p1.screen.x+r.offset*Math.abs(t.p1.screen.w),k=t.p1.screen.y,l=1;var T=drawDistance-e;r.source!==GATE.START?(i=r.source===GATE.GOAL?(updateRibbon(M,k,I,T),resources.gate.textures[r.source]):_texture_scene[v][r.source],Render.sprite(_scene_side.getChildAt(2*C+(r.offset<0?0:1)),i,M,k,I,T,l)):(i=resources.gate.textures[r.source],T=drawDistance,Render.trafficLight(_container_traffic_light,M,k,I,T),Render.sprite(_start_gate,i,M,k,I,T,l))}for(S=0;S<t.coins.length;++S)R[a=0==(n=t.coins[S]).offsetX?0:n.offsetX<0?1:2]||(I=CoinScale*t.p1.project.y*height*RoadRatio*RoadSpriteXScale*SpriteScale*(1-n.offsetY),M=offset_width+t.p1.screen.x+n.offsetX*Math.abs(t.p1.screen.w)/lanes*2,k=t.p1.screen.y-Util.easeInOut(0,1,n.offsetY)*height,l=1,i=n.source===SPRITE_ROAD.COMBO[0]?300<=Math.floor(1e3*currentLapTime)%600?_texture_road[SPRITE_ROAD.COMBO[0]]:_texture_road[SPRITE_ROAD.COMBOGLOW[0]]:_texture_road[n.source],Render.sprite(_scene_road.getChildAt(3*C+a),i,M,k,I,drawDistance-e,l));for(S=0;S<t.obstacles.length;++S)R[a=0==(s=t.obstacles[S]).offsetX?0:s.offsetX<0?1:2]||(I=ObstacleScale*t.p1.project.y*height*RoadRatio*RoadSpriteWScale*SpriteScale*1.2*(1-s.offsetY),M=offset_width+t.p1.screen.x+s.offsetX*Math.abs(t.p1.screen.w)/lanes*2,k=t.p1.screen.y-Util.easeInOut(0,1,s.offsetY)*height,l=1,i=_texture_road[s.source],a=0==s.offsetX?0:s.offsetX<0?1:2,Render.sprite(_scene_road.getChildAt(3*C+a),i,M,k,I,drawDistance-e,l));for(S=0;S<t.cars.length;++S){(o=t.cars[S]).offsetX<0&&0<=playerX||0==o.offsetX&&0<playerX?r=OTHER_CAR[o.color].left:0<o.offsetX&&playerX<=0||0==o.offsetX&&playerX<0?OTHER_CAR[o.color].right:r=OTHER_CAR[o.color].center,i=resources.other_car.textures[r];var b,E,y,I,M,k,O=Util.interpolate(t.p1.project.y,t.p2.project.y||0,o.percent);O<yproj[mDrawSegment]||(b=Util.interpolate(t.p1.screen.x,t.p2.screen.x||0,o.percent),E=Util.interpolate(t.p1.screen.y,t.p2.screen.y||0,o.percent),y=Util.interpolate(t.p1.screen.w,t.p2.screen.w||0,o.percent),I=O*height*RoadRatio*RoadSpriteWScale*SpriteScale*1.2*(1-o.offsetY),M=offset_width+b+o.offsetX*Math.abs(y)/lanes*2,k=E-Util.easeInOut(0,1,o.offsetY)*height,Render.sprite(_other_car.getChildAt(o.index%_other_car.children.length),i,M,k,I,cars.length-S,l))}t==g&&(m=CarScale,f=offset_width+width/2,h=height,t.index>sceneSegment[2]-endGateZ/segmentLength&&(m=t.index>=sceneSegment[2]+drawDistance-endGateZ/segmentLength?0:t.p1.project.y*height*RoadRatio*RoadSpriteWScale*SpriteScale*1.2,f=offset_width+t.p1.screen.x+playerX*Math.abs(t.p1.screen.w)/lanes*2,h=t.p1.screen.y),Render.player(resolution,speed/BaseSpeed,m,f,h,speed*(keyLeft?-1:keyRight?1:0)))}}function findSegment(e){return segments[Math.floor(e/segmentLength)%segments.length]}function findSegmentScene(e){for(var t=0;t<totalScene;++t)if(e<=sceneSegment[t])return t;return totalScene-1}function lastY(){return 0==segments.length?0:segments[segments.length-1].p2.world.y}function addSegment(e,t,o){var r=segments.length;segments.push({index:r,p1:{world:{y:lastY(),z:r*segmentLength},camera:{},screen:{},project:[]},p2:{world:{y:t,z:(r+1)*segmentLength},camera:{},screen:{},project:[]},curve:e,sprites:[],cars:[],coins:[],obstacles:[],color:Math.floor(r/rumbleLength)%2?COLORS.DARK:COLORS.LIGHT,scene:o})}function addSprite(e,t,o){segments[e].sprites.push({source:t,offset:o})}function addRoad(e,t,o,r,n,a){for(var s=lastY(),i=s+Util.toInt(n,0)*segmentLength,l=e+t+o,c=0;c<e;c++)addSegment(Util.easeIn(0,r,c/e),Util.easeInOut(s,i,c/l),a);for(c=0;c<t;c++)addSegment(r,Util.easeInOut(s,i,(e+c)/l),a);for(c=0;c<o;c++)addSegment(Util.easeInOut(r,0,c/o),Util.easeInOut(s,i,(e+t+c)/l),a)}var ROAD={LENGTH:{NONE:0,SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{NONE:0,EASY:2,MEDIUM:4,HARD:6}};function addStraight(e,t){addRoad(0,e=e||ROAD.LENGTH.MEDIUM,0,0,0,t)}function addHill(e,t,o){addRoad(e=e||ROAD.LENGTH.MEDIUM,e,e,0,t=t||ROAD.HILL.MEDIUM,o)}function addCurve(e,t,o,r){addRoad(e=e||ROAD.LENGTH.MEDIUM,e,e,t=t||ROAD.CURVE.MEDIUM,o=o||ROAD.HILL.NONE,r)}function addLowRollingHills(e,t,o){addRoad(e=e||ROAD.LENGTH.SHORT,e,e,0,(t=t||ROAD.HILL.LOW)/2,o),addRoad(e,e,e,0,-t,o),addRoad(e,e,e,ROAD.CURVE.EASY,t,o),addRoad(e,e,e,0,0,o),addRoad(e,e,e,-ROAD.CURVE.EASY,t/2,o),addRoad(e,e,e,0,0,o)}function addSCurves(e){addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.NONE,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.MEDIUM,ROAD.HILL.MEDIUM,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.CURVE.EASY,-ROAD.HILL.LOW,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.EASY,ROAD.HILL.MEDIUM,e),addRoad(ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,ROAD.LENGTH.MEDIUM,-ROAD.CURVE.MEDIUM,-ROAD.HILL.MEDIUM,e)}function addBumps(e){addRoad(10,10,10,0,5,e),addRoad(10,10,10,0,-2,e),addRoad(10,10,10,0,-5,e),addRoad(10,10,10,0,8,e),addRoad(10,10,10,0,5,e),addRoad(10,10,10,0,-7,e),addRoad(10,10,10,0,5,e),addRoad(10,10,10,0,-2,e)}function addDownhillToEnd(e,t){addRoad(e=e||200,e,e,-ROAD.CURVE.EASY,-lastY()/segmentLength,t)}function resetRoad(e,t){segments=[],addStraight(sceneSegment[0],0),addStraight(sceneSegment[1]-sceneSegment[0],1);var o=startGateZ/segmentLength;addStraight(sceneSegment[2]-sceneSegment[1]+drawDistance,2),addSprite(o,GATE.START,0),addSprite(sceneSegment[totalScene-1],GATE.GOAL,0),readMap(e,t),trackLength=segments.length*segmentLength}function setupScene(e){indexScene=e,console.log("-------------Enter scene "+e+"  "+formatTime(currentLapTime)+"-------------"),speed=sceneSpeedRatio[e]*BaseSpeed,accel=0==e?(sceneSpeedRatio[e+1]*BaseSpeed-speed)/3:(sceneSpeedRatio[e+1]*BaseSpeed-speed)/sceneInterval[e],console.log("v= "+speed+"  a= "+accel)}function lerpColor(e,t,o){return new Float32Array([Util.interpolate(e[0],t[0],o),Util.interpolate(e[1],t[1],o),Util.interpolate(e[2],t[2],o),Util.interpolate(e[3],t[3],o)])}function setShaderUniforms(e,t,o){_shader_road.uniforms.roadColor1=lerpColor(SceneColor[e].roadColor1,SceneColor[t].roadColor1,o),_shader_road.uniforms.roadColor2=lerpColor(SceneColor[e].roadColor2,SceneColor[t].roadColor2,o),_shader_road.uniforms.laneColor1=lerpColor(SceneColor[e].laneColor1,SceneColor[t].laneColor1,o),_shader_road.uniforms.laneColor2=lerpColor(SceneColor[e].laneColor2,SceneColor[t].laneColor2,o),_shader_road.uniforms.grassColor1=lerpColor(SceneColor[e].grassColor1,SceneColor[t].grassColor1,o),_shader_road.uniforms.grassColor2=lerpColor(SceneColor[e].grassColor2,SceneColor[t].grassColor2,o),_shader_road.uniforms.grassColor3=lerpColor(SceneColor[e].grassColor3,SceneColor[t].grassColor3,o),_shader_road.uniforms.grassColor4=lerpColor(SceneColor[e].grassColor4,SceneColor[t].grassColor4,o),_shader_road.uniforms.sideColor1=lerpColor(SceneColor[e].sideColor1,SceneColor[t].sideColor1,o),_shader_road.uniforms.sideColor2=lerpColor(SceneColor[e].sideColor2,SceneColor[t].sideColor2,o)}