var Container,autoDetectRenderer,loader,resources,Sprite,Texture,Rectangle,Ticker,_app,_background,_sky,_mountain,_road,_scene_side,_scene_road,_other_car,_car,_car_texture_arr,_ribbon,_container_traffic_light,_start_gate,_index_traffic_light,_texture_car,_texture_road,_last_car_pos,_dest_mountain,_shader_road,_shader_lane,_shader_rumble,_windowWidth,_windowHeight,CarScale,_sound_bgm,_sound_game,_resize_timeout,audio_context,_texture_scene=[],RoadRatio=.6,MoutainRatio=.124,SpriteScale=1/513,RibbonCount=50,PolyPerSeg=lanes-1+6,_sound_fx={},url=window.location.href,MapURL="https://event.bmw.com.tw/campaign/2020/the2_racing_challenge/vender/asset/map/map-3.csv",OtherCarCount=10,_game_loaded=!1,_sound_loaded=!1,_game_elapse_time=0;function onload(){invalid_device?$("#_hint_webview").css("display","block"):($("body").scrollTop(0),_inTransition=!0,$("#_button_start").addClass("Disable"),setupPixi(),loadTexture(),loadSound(),hud={speed:{value:null,dom:$("#_speed_value")},score:{value:null,dom:$("#_hud_score")},time:{value:null,dom:$("#_hud_time")},life:{value:null,dom:$("#_life_star")}},Game.setKeyListener([{keys:[KEY.LEFT,KEY.A],mode:"down",action:function(){keyLeft=!0}},{keys:[KEY.RIGHT,KEY.D],mode:"down",action:function(){keyRight=!0}},{keys:[KEY.LEFT,KEY.A],mode:"up",action:function(){keyLeft=!1}},{keys:[KEY.RIGHT,KEY.D],mode:"up",action:function(){keyRight=!1}}]),window.addEventListener("resize",resize,!1),window.addEventListener("orientationchange",resize,!1),window.PointerEvent&&(document.getElementById("_game_touch_frame").addEventListener("pointerdown",onGameClick),document.getElementById("_game_touch_frame").addEventListener("pointerup",onGameMouseUp)),document.getElementById("_game_touch_frame").addEventListener("touchstart",function(e){var t;e.preventDefault(),isPlaying&&((t=e.pageX/width)<ClickBorder?keyLeft=!0:t>1-ClickBorder&&(keyRight=!0))}),document.getElementById("_game_touch_frame").addEventListener("touchend",function(e){e.preventDefault(),keyLeft=!1,keyRight=!1}),document.getElementById("_game_touch_frame").addEventListener("mousedown",onGameClick),document.getElementById("_game_touch_frame").addEventListener("mouseup",onGameMouseUp),$("#_input_driver").bind("change paste keyup",function(e){13===e.which&&$(this).blur(),toggleNameError(!1),$("#_input_driver").val($("#_input_driver").val().replace(/ /g,""))}),$("#_input_lottery_name").bind("change paste keyup",function(e){13===e.which&&$(this).blur(),toggleLotteryError(!1),$("#_input_lottery_name").val($("#_input_lottery_name").val().replace(/ /g,""))}),$("#_input_lottery_phone").bind("change paste keyup",function(e){13===e.which&&$(this).blur(),toggleLotteryError(!1),$(this).val($(this).val().replace(/[^\d]+/g,"")),$(this).val($(this).val().replace(/(\d{4})\-?(\d{3})\-?(\d{3})/,"$1-$2-$3"))}),$("#_input_lottery_email").bind("change paste keyup",function(e){13===e.which&&$(this).blur(),toggleLotteryError(!1),$("#_input_lottery_email").val($("#_input_lottery_email").val().replace(/ /g,""))}),$("bdoy").scrollTop(0),bodyScrollLock.disableBodyScroll(document.querySelector("#_lottery_info")),bodyScrollLock.disableBodyScroll(document.querySelector("#_campaign_wrapper")),bodyScrollLock.disableBodyScroll(document.querySelector("#_rank_info")),bodyScrollLock.disableBodyScroll(document.querySelector("#_rank_wrapper")),resize())}function resize(){Ticker.started&&Ticker.stop(),doResize()}function doResize(){if((window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth)<(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight))return $("#_hint_landscape").css("display","block"),void $("#_body_wrapper").css({height:"100%",marginTop:0});$("body").height(),window.innerHeight;if($("#_body_wrapper").css({height:window.innerHeight}),$("bdoy").scrollTop(0),$("#_hint_landscape").css("display","none"),ww_=$("#_game_container").width(),wh_=$("#_game_container").height(),console.log("window size:"+ww_+" x "+wh_),_windowWidth=ww_,_windowHeight=wh_,height=_windowHeight,width=Math.min(_windowWidth,height/9*16),offset_width=ww_/2-width/2,!Ticker.started&&0<=_game_elapse_time&&Ticker.start(),_app){_sky&&(_sky.width=ww_,_sky.height=wh_*(1-RoadRatio+yproj[drawDistance/segmentPerDraw]),_sky.tileScale.x=_sky.tileScale.y=ww_/resources.sky.texture.width),_mountain&&(_mountain.y=_windowHeight*(1-RoadRatio+yproj[drawDistance/segmentPerDraw])),computeCarScale(),_app.renderer.resize(ww_,wh_);try{update(0),render()}catch(e){console.log(e)}}}function computeCarScale(){CarScale=Math.max(width/3*.8/480,height/5/413)}function checkLoading(){_sound_loaded&&_game_loaded&&(_inTransition=!1,$("#_button_start").removeClass("Disable"),hideItem($("#_loading")))}function setupPixi(){Container=PIXI.Container,autoDetectRenderer=PIXI.autoDetectRenderer,loader=PIXI.Loader.shared,Sprite=PIXI.Sprite,Texture=PIXI.Texture,Rectangle=PIXI.Rectangle,(Ticker=PIXI.Ticker.shared).autoStart=!1,_windowWidth=$("#_game_container").width(),_windowHeight=$("#_game_container").height(),height=_windowHeight,width=Math.min(_windowWidth,height/9*16),offset_width=_windowWidth/2-width/2,_app=new PIXI.Application({autoResize:!0,resolution:devicePixelRatio,antialias:!0,transparent:!0,width:_windowWidth,height:_windowHeight}),document.getElementById("_game_frame").appendChild(_app.view)}function loadTexture(){loader.add("sky","asset/img/texture-02.png").add("mountain","asset/img/sprite/mountain.json").add("road","asset/img/texture/txt-24.png").add("side_road","asset/img/texture/txt-27.png").add("ref","asset/img/ref.png").add("road_element","asset/img/sprite/road.json").add("other_car","asset/img/sprite/other_car.json").add("scene1","asset/img/sprite/scene1.json").add("scene2","asset/img/sprite/scene2.json").add("scene3","asset/img/sprite/scene3.json").add("gate","asset/img/sprite/gate.json").add("ribbon","asset/img/sprite/ribbon.json").add("car_1","asset/img/sprite/car-1.json").add("car_2","asset/img/sprite/car-2.json").add("car_3","asset/img/sprite/car-3.json").add("car_4","asset/img/sprite/car-4.json").add("car_5","asset/img/sprite/car-5.json").add("car_6","asset/img/sprite/car-6.json").load(loadFinish)}function loadFinish(e,t){resources=t,_background=new Container,_app.stage.addChild(_background),(_sky=new PIXI.TilingSprite(resources.sky.texture,_windowWidth,_windowHeight*(1-RoadRatio+yproj[drawDistance/segmentPerDraw]))).tileScale.x=_sky.tileScale.y=_windowWidth/resources.sky.texture.width,(_mountain=new Container).width=_windowWidth,_mountain.height=_windowHeight*MoutainRatio;for(var n=0;n<3;++n)_mountain.addChild(new PIXI.Sprite(resources.mountain.textures["mountain-02.png"]));_mountain.y=_windowHeight*(1-RoadRatio+yproj[drawDistance/segmentPerDraw]),addMountain(),_texture_scene.push(resources.scene1.textures),_texture_scene.push(resources.scene2.textures),_texture_scene.push(resources.scene3.textures),_texture_road=resources.road_element.textures,_container_traffic_light=new PIXI.Container;for(n=0;n<6;++n)_container_traffic_light.addChild(new PIXI.Sprite(resources.gate.textures["light_cover.png"]));setTrafficLight(0),_start_gate=new PIXI.Sprite(resources.gate.textures["start.png"]);var a={uSampler:resources.road.texture,uColor:new Float32Array([1,1,1,1]),vColor:1,width:width,height:height,roadColor1:SceneColor[indexScene].roadColor1,roadColor2:SceneColor[indexScene].roadColor2,laneColor1:SceneColor[indexScene].laneColor1,laneColor2:SceneColor[indexScene].laneColor2,grassColor1:SceneColor[indexScene].grassColor1,grassColor2:SceneColor[indexScene].grassColor2,grassColor3:SceneColor[indexScene].grassColor3,grassColor4:SceneColor[indexScene].grassColor4,sideColor1:SceneColor[indexScene].sideColor1,sideColor2:SceneColor[indexScene].sideColor2};_shader_road=PIXI.Shader.from(vertex_shader,frag_shader,a),_road=new Container,_scene_side=new Container,(_scene_road=new Container).sortableChildren=!0,_scene_side.sortableChildren=!0;for(var r=0;r<drawDistance;r++)for(n=0;n<PolyPerSeg;++n)_road.addChild(new PIXI.Mesh(createQuadGeometry(r%segmentPerDraw/segmentPerDraw,0,0,0,0,0,0,0,0),_shader_road));for(r=0;r<drawDistance;r++){var o=new PIXI.Sprite,i=new PIXI.Sprite,s=drawDistance-r;o.zIndex=s,i.zIndex=s,_scene_side.addChild(o),_scene_side.addChild(i);var d=new PIXI.Sprite,_=new PIXI.Sprite,c=new PIXI.Sprite;d.zIndex=drawDistance-r,_.zIndex=drawDistance-r,c.zIndex=drawDistance-r,_scene_road.addChild(d),_scene_road.addChild(_),_scene_road.addChild(c)}_ribbon=new Container;for(r=0;r<RibbonCount;++r){var u=Math.floor(12*Math.random())+1,l=new PIXI.Sprite(resources.ribbon.textures["ribbon-"+pad(u,2)+".png"]);l.scaleX=Math.random(),l.scaleY=Math.random(),l.angle=360*Math.random(),l.speed=.01*Math.random()+.01,_ribbon.addChild(l)}_driver_color="blue",setupCarSprite(_driver_color),computeCarScale(),_other_car=new Container;for(r=0;r<OtherCarCount;++r)_other_car.addChild(new PIXI.Sprite(resources.other_car.textures["car1-center.png"]));_other_car.sortableChildren=!0,_background.addChild(_sky),_background.addChild(_mountain),_background.addChild(_road),_background.addChild(_scene_side),_background.addChild(_scene_road),_background.addChild(_other_car),_background.addChild(_car),_background.addChild(_start_gate),_background.addChild(_container_traffic_light),_background.addChild(_ribbon),Ticker.add(function(e){var t;segments.length<1||(t=_app.ticker.deltaMS/1e3,update(t),render())}),_game_loaded=!0,checkLoading()}function setupCarSprite(e){switch(e){case"blue":0;break;case"red":0;break;case"gray":0;break;case"white":0}null==_car_texture_arr?_car_texture_arr={left:[],right:[],center:[]}:(_car_texture_arr.left=[],_car_texture_arr.right=[],_car_texture_arr.center=[]);for(var t=0;t<6;++t)_car_texture_arr.left.push(resources["car_"+(t+1)].textures["car-"+(t+1)+"-"+e+"-left.png"]),_car_texture_arr.right.push(resources["car_"+(t+1)].textures["car-"+(t+1)+"-"+e+"-right.png"]),_car_texture_arr.center.push(resources["car_"+(t+1)].textures["car-"+(t+1)+"-"+e+"-center.png"]);_last_car_pos="center",null==_car?_car=new PIXI.AnimatedSprite(_car_texture_arr[_last_car_pos]):_car.textures=_car_texture_arr[_last_car_pos]}function setupGame(){if(doResize(),_app.renderer.clear(),console.log("------ set up game ----------"),position=0,score=0,life=MaxLife,currentLapTime=0,speed=0,lastSegment=0,setupScene(0),playerX=0,isPlaying=!1,_game_elapse_time=-1,updateHud(),cameraDepth=1/Math.tan(fieldOfView/2*Math.PI/180),resolution=height/480,roadWidth=height*RoadRatio/cameraDepth,0==dk.length)for(var e=0;e<mDrawSegment+1;++e)dk.push(yproj[e]*(((e+1)*segmentLength*segmentPerDraw-cameraDepth)/cameraHeight));setupCarSprite(_driver_color),indexScene=0,setupScene(indexScene),setShaderUniforms(indexScene,indexScene,0),setTrafficLight(0),Ticker.start(),resetRoad(MapURL,function(){indexScene=0,_ribbon.visible=!1,setTrafficLight(0),update(0),render()})}function startGame(){hideItem($("#_hint")),_sound_fx.button_large.play(),_sound_game.seek(0),_sound_game.stop();for(var e=0;e<RibbonCount;++e)_ribbon.getChildAt(i).visible=!1;_sound_bgm.stop(),_sound_fx.light_count.play(),_sound_fx.light_count.seek(0),_game_elapse_time=0,console.log("------------- Start Game -------------"),gtag("event","Start_game"),gtag("event","Nav Click",{event_category:"Click",event_label:"Start_game"})}function createQuadGeometry(e,t,n,a,r,o,i,s,d){var _=[t,n,a,r,o,i,s,d],c=[0,e+1/segmentPerDraw,0,e,1,e,1,e+1/segmentPerDraw],e=[0,1,2,0,2,3],u=new PIXI.Geometry;return u.addAttribute("aVertexPosition",_,2),u.addAttribute("aTextureCoord",c,2),u.addIndex(e),u}function endGame(e){if(isPlaying)if(_sound_game.stop(),isPlaying=!1,console.log("------------- End Game "+formatTime(currentLapTime)+"-------------"),e)_sound_fx.fail.play(),doneScore();else if(_sound_fx.goal.play(),_sound_fx.goal.volume(1),0<life)for(var t=0;t<=life;++t)setTimeout(function(){0<life?(score+=10,--life,updateHud(),_sound_fx.combo.play()):doneScore()},300*(t+1));else doneScore()}function pauseGame(){_game_elapse_time<0||(3<=_game_elapse_time?_sound_game.fade(1,.2,500):0<=_game_elapse_time&&_sound_fx.light_count.pause(),Ticker.stop())}function resumeGame(){_game_elapse_time<0||(3<=_game_elapse_time?_sound_game.fade(.2,1,500):0<=_game_elapse_time&&_sound_fx.light_count.play(),Ticker.start())}function exitGame(){_sound_game.stop(),isPlaying=!1,_game_elapse_time=-1,Ticker.stop()}function doneScore(){setDriverScore(score),setTimeout(function(){showScore(),_sound_fx.goal.playing()&&_sound_fx.goal.fade(1,0,500),_sound_bgm.play(),_sound_bgm.fade(0,1,2e3),Ticker.stop()},500+(0<life?300*(life+1):0))}function setTrafficLight(e){if(_container_traffic_light.getChildAt(e).visible)for(var t=0;t<2;++t)for(var n=0;n<3;++n)_container_traffic_light.getChildAt(3*t+n).visible=n!=e}function loadSound(){Howler.autoUnlock=!1,_sound_bgm=new Howl({src:["asset/sound/webm/bgm_buy.webm","asset/sound/mp3/bgm_buy.mp3"],onplayerror:function(){_sound_bgm.once("unlock",function(){_sound_bgm.play()})},onload:function(){_sound_loaded=!0,checkLoading()}}),_sound_game=new Howl({src:["asset/sound/webm/game.webm","asset/sound/mp3/game.mp3"],loop:!0}),_sound_fx.button_large=new Howl({src:["asset/sound/webm/button_large.webm","asset/sound/mp3/button_large.mp3"]}),_sound_fx.button_small=new Howl({src:["asset/sound/webm/button_small.webm","asset/sound/mp3/button_small.mp3"]}),_sound_fx.button_disable=new Howl({src:["asset/sound/webm/button_disable.webm","asset/sound/mp3/button_disable.mp3"]}),_sound_fx.light_count=new Howl({src:["asset/sound/webm/light_count.webm","asset/sound/mp3/light_count.mp3"]}),_sound_fx.coin=new Howl({src:["asset/sound/webm/coin_1.webm","asset/sound/mp3/coin_1.mp3","asset/sound/wav/coin_1.wav"]}),_sound_fx.combo=new Howl({src:["asset/sound/webm/combo_2.webm","asset/sound/mp3/combo_2.mp3"]}),_sound_fx.bump=new Howl({src:["asset/sound/webm/bump.webm","asset/sound/mp3/bump.mp3"]}),_sound_fx.horn=new Howl({src:["asset/sound/webm/horn.webm","asset/sound/mp3/horn.mp3"]}),_sound_fx.engine=new Howl({src:["asset/sound/webm/engine.webm","asset/sound/mp3/engine.mp3"]}),_sound_fx.goal=new Howl({src:["asset/sound/webm/goal.webm","asset/sound/mp3/goal.mp3"]}),_sound_fx.other_car=new Howl({src:["asset/sound/webm/other_car.webm","asset/sound/mp3/other_car.mp3"]}),_sound_fx.fail=new Howl({src:["asset/sound/webm/fail.webm","asset/sound/mp3/fail.mp3"]})}function updateRibbon(e,t,n,a){e=width/2,t=height;var r,o=width,i=height;e-=o/2,t-=i;for(var s=0;s<RibbonCount;++s)(r=_ribbon.getChildAt(s)).x=r.scaleX*o+e,r.y=r.scaleY*i+t,r.angle=(r.angle+.01)%360,r.scaleY+=r.speed,1<=r.scaleY&&(r.scaleY=.3*-Math.random())}function addMountain(){var e=_windowWidth/2048,t=new PIXI.Sprite(resources.mountain.textures["mountain-01.png"]);t.anchor.set(.5,1),t.scale.x=e,t.scale.y=e,t.x=t.texture.width*e/2,_mountain.addChild(t);var n=new PIXI.Sprite(resources.mountain.textures["mountain-02.png"]);n.anchor.set(.5,1),n.scale.y=e,n.scale.x=e,n.x=t.texture.width*e+n.texture.width*e/2,_mountain.addChild(n);var a=new PIXI.Sprite(resources.mountain.textures["mountain-04.png"]);a.anchor.set(.5,1),a.scale.x=e,a.scale.y=e,a.x=n.x+n.texture.width/2*e+a.texture.width*e/2,_mountain.addChild(a);var r=new PIXI.Sprite(resources.mountain.textures["mountain-03.png"]);r.anchor.set(.5,1),r.scale.x=e,r.scale.y=e,r.x=a.x+a.texture.width/2*e+r.texture.width*e/2,_mountain.addChild(r);var o=new PIXI.Sprite(resources.mountain.textures["mountain-06.png"]);o.anchor.set(.5,1),o.scale.x=e,o.scale.y=e,o.x=r.x+r.texture.width/2*e+o.texture.width*e/2,_mountain.addChild(o);var i=new PIXI.Sprite(resources.mountain.textures["mountain-05.png"]);i.anchor.set(.5,1),i.anchor.set(.5,1),i.scale.x=e,i.scale.y=e,i.x=o.x+o.texture.width/2*e+i.texture.width*e/2,_mountain.addChild(i);var s=new PIXI.Sprite(resources.mountain.textures["mountain-06.png"]);s.anchor.set(.5,1),s.scale.x=e,s.scale.y=e,s.x=i.x+i.texture.width/2*e+s.texture.width*e/2,_mountain.addChild(s),_dest_mountain=-(i.x-width/2)}